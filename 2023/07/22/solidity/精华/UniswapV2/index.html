<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>UniswapV2 | JKingğŸ¥</title><meta name="author" content="jjk"><meta name="copyright" content="jjk"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="ERC20&amp;&amp;Pair&amp;&amp;FactoryTotal Code1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818">
<meta property="og:type" content="article">
<meta property="og:title" content="UniswapV2">
<meta property="og:url" content="https://www.jjkwin.top/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/UniswapV2/index.html">
<meta property="og:site_name" content="JKingğŸ¥">
<meta property="og:description" content="ERC20&amp;&amp;Pair&amp;&amp;FactoryTotal Code1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/11/27/S7982YFMinXbqNg.jpg">
<meta property="article:published_time" content="2023-07-22T13:13:14.393Z">
<meta property="article:modified_time" content="2023-07-22T13:14:05.879Z">
<meta property="article:author" content="jjk">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/11/27/S7982YFMinXbqNg.jpg"><link rel="shortcut icon" href="/img/j.JPG"><link rel="canonical" href="https://www.jjkwin.top/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/UniswapV2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹„1ï¿½7","msgToSimplifiedChinese":"ç®€"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'UniswapV2',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-22 21:14:05'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/macblack.css"> - <link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/w.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> åˆ—è¡¨</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope-open"></i><span> ç•™è¨€æ¿</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2022/11/27/S7982YFMinXbqNg.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">JKingğŸ¥</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> åˆ—è¡¨</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope-open"></i><span> ç•™è¨€æ¿</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">UniswapV2</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-07-22T13:13:14.393Z" title="å‘è¡¨äº 2023-07-22 21:13:14">2023-07-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-07-22T13:14:05.879Z" title="æ›´æ–°äº 2023-07-22 21:14:05">2023-07-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%9F%A5%E8%AF%86/">-çŸ¥è¯†</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">9.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>57åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="UniswapV2"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ERC20-amp-amp-Pair-amp-amp-Factory"><a href="#ERC20-amp-amp-Pair-amp-amp-Factory" class="headerlink" title="ERC20&amp;&amp;Pair&amp;&amp;Factory"></a>ERC20&amp;&amp;Pair&amp;&amp;Factory</h1><h2 id="Total-Code"><a href="#Total-Code" class="headerlink" title="Total Code"></a>Total Code</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity =0.5.16;</span><br><span class="line"></span><br><span class="line">interface IUniswapV2Factory &#123;</span><br><span class="line">    event PairCreated(address indexed token0, address indexed token1, address pair, uint);</span><br><span class="line"></span><br><span class="line">    function feeTo() external view returns (address);</span><br><span class="line">    function feeToSetter() external view returns (address);</span><br><span class="line"></span><br><span class="line">    function getPair(address tokenA, address tokenB) external view returns (address pair);</span><br><span class="line">    function allPairs(uint) external view returns (address pair);</span><br><span class="line">    function allPairsLength() external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function createPair(address tokenA, address tokenB) external returns (address pair);</span><br><span class="line"></span><br><span class="line">    function setFeeTo(address) external;</span><br><span class="line">    function setFeeToSetter(address) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IUniswapV2Pair &#123;</span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint value);</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint value);</span><br><span class="line"></span><br><span class="line">    function name() external pure returns (string memory);</span><br><span class="line">    function symbol() external pure returns (string memory);</span><br><span class="line">    function decimals() external pure returns (uint8);</span><br><span class="line">    function totalSupply() external view returns (uint);</span><br><span class="line">    function balanceOf(address owner) external view returns (uint);</span><br><span class="line">    function allowance(address owner, address spender) external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint value) external returns (bool);</span><br><span class="line">    function transfer(address to, uint value) external returns (bool);</span><br><span class="line">    function transferFrom(address from, address to, uint value) external returns (bool);</span><br><span class="line"></span><br><span class="line">    function DOMAIN_SEPARATOR() external view returns (bytes32);</span><br><span class="line">    function PERMIT_TYPEHASH() external pure returns (bytes32);</span><br><span class="line">    function nonces(address owner) external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s) external;</span><br><span class="line"></span><br><span class="line">    event Mint(address indexed sender, uint amount0, uint amount1);</span><br><span class="line">    event Burn(address indexed sender, uint amount0, uint amount1, address indexed to);</span><br><span class="line">    event Swap(</span><br><span class="line">        address indexed sender,</span><br><span class="line">        uint amount0In,</span><br><span class="line">        uint amount1In,</span><br><span class="line">        uint amount0Out,</span><br><span class="line">        uint amount1Out,</span><br><span class="line">        address indexed to</span><br><span class="line">    );</span><br><span class="line">    event Sync(uint112 reserve0, uint112 reserve1);</span><br><span class="line"></span><br><span class="line">    function MINIMUM_LIQUIDITY() external pure returns (uint);</span><br><span class="line">    function factory() external view returns (address);</span><br><span class="line">    function token0() external view returns (address);</span><br><span class="line">    function token1() external view returns (address);</span><br><span class="line">    function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast);</span><br><span class="line">    function price0CumulativeLast() external view returns (uint);</span><br><span class="line">    function price1CumulativeLast() external view returns (uint);</span><br><span class="line">    function kLast() external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function mint(address to) external returns (uint liquidity);</span><br><span class="line">    function burn(address to) external returns (uint amount0, uint amount1);</span><br><span class="line">    function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external;</span><br><span class="line">    function skim(address to) external;</span><br><span class="line">    function sync() external;</span><br><span class="line"></span><br><span class="line">    function initialize(address, address) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IUniswapV2ERC20 &#123;</span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint value);</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint value);</span><br><span class="line"></span><br><span class="line">    function name() external pure returns (string memory);</span><br><span class="line">    function symbol() external pure returns (string memory);</span><br><span class="line">    function decimals() external pure returns (uint8);</span><br><span class="line">    function totalSupply() external view returns (uint);</span><br><span class="line">    function balanceOf(address owner) external view returns (uint);</span><br><span class="line">    function allowance(address owner, address spender) external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint value) external returns (bool);</span><br><span class="line">    function transfer(address to, uint value) external returns (bool);</span><br><span class="line">    function transferFrom(address from, address to, uint value) external returns (bool);</span><br><span class="line"></span><br><span class="line">    function DOMAIN_SEPARATOR() external view returns (bytes32);</span><br><span class="line">    function PERMIT_TYPEHASH() external pure returns (bytes32);</span><br><span class="line">    function nonces(address owner) external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IERC20 &#123;</span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint value);</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint value);</span><br><span class="line"></span><br><span class="line">    function name() external view returns (string memory);</span><br><span class="line">    function symbol() external view returns (string memory);</span><br><span class="line">    function decimals() external view returns (uint8);</span><br><span class="line">    function totalSupply() external view returns (uint);</span><br><span class="line">    function balanceOf(address owner) external view returns (uint);</span><br><span class="line">    function allowance(address owner, address spender) external view returns (uint);</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint value) external returns (bool);</span><br><span class="line">    function transfer(address to, uint value) external returns (bool);</span><br><span class="line">    function transferFrom(address from, address to, uint value) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface IUniswapV2Callee &#123;</span><br><span class="line">    function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract UniswapV2ERC20 is IUniswapV2ERC20 &#123;</span><br><span class="line">    using SafeMath for uint;</span><br><span class="line"></span><br><span class="line">    string public constant name = &#x27;Uniswap V2&#x27;;</span><br><span class="line">    string public constant symbol = &#x27;UNI-V2&#x27;;</span><br><span class="line">    uint8 public constant decimals = 18;</span><br><span class="line">    uint  public totalSupply;</span><br><span class="line">    mapping(address =&gt; uint) public balanceOf;</span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint)) public allowance;</span><br><span class="line"></span><br><span class="line">    bytes32 public DOMAIN_SEPARATOR;</span><br><span class="line">    // keccak256(&quot;Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;);</span><br><span class="line">    bytes32 public constant PERMIT_TYPEHASH = 0x6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c9;</span><br><span class="line">    mapping(address =&gt; uint) public nonces;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint value);</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint value);</span><br><span class="line"></span><br><span class="line">    constructor() public &#123;</span><br><span class="line">        uint chainId;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            chainId := chainid</span><br><span class="line">        &#125;</span><br><span class="line">        DOMAIN_SEPARATOR = keccak256(</span><br><span class="line">            abi.encode(</span><br><span class="line">                keccak256(&#x27;EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)&#x27;),</span><br><span class="line">                keccak256(bytes(name)),</span><br><span class="line">                keccak256(bytes(&#x27;1&#x27;)),</span><br><span class="line">                chainId,</span><br><span class="line">                address(this)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _mint(address to, uint value) internal &#123;</span><br><span class="line">        totalSupply = totalSupply.add(value);</span><br><span class="line">        balanceOf[to] = balanceOf[to].add(value);</span><br><span class="line">        emit Transfer(address(0), to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(address from, uint value) internal &#123;</span><br><span class="line">        balanceOf[from] = balanceOf[from].sub(value);</span><br><span class="line">        totalSupply = totalSupply.sub(value);</span><br><span class="line">        emit Transfer(from, address(0), value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _approve(address owner, address spender, uint value) private &#123;</span><br><span class="line">        allowance[owner][spender] = value;</span><br><span class="line">        emit Approval(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _transfer(address from, address to, uint value) private &#123;</span><br><span class="line">        balanceOf[from] = balanceOf[from].sub(value);</span><br><span class="line">        balanceOf[to] = balanceOf[to].add(value);</span><br><span class="line">        emit Transfer(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint value) external returns (bool) &#123;</span><br><span class="line">        _approve(msg.sender, spender, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint value) external returns (bool) &#123;</span><br><span class="line">        _transfer(msg.sender, to, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint value) external returns (bool) &#123;</span><br><span class="line">        if (allowance[from][msg.sender] != uint(-1)) &#123;</span><br><span class="line">            allowance[from][msg.sender] = allowance[from][msg.sender].sub(value);</span><br><span class="line">        &#125;</span><br><span class="line">        _transfer(from, to, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s) external &#123;</span><br><span class="line">        require(deadline &gt;= block.timestamp, &#x27;UniswapV2: EXPIRED&#x27;);</span><br><span class="line">        bytes32 digest = keccak256(</span><br><span class="line">            abi.encodePacked(</span><br><span class="line">                &#x27;\x19\x01&#x27;,</span><br><span class="line">                DOMAIN_SEPARATOR,</span><br><span class="line">                keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, nonces[owner]++, deadline))</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        address recoveredAddress = ecrecover(digest, v, r, s);</span><br><span class="line">        require(recoveredAddress != address(0) &amp;&amp; recoveredAddress == owner, &#x27;UniswapV2: INVALID_SIGNATURE&#x27;);</span><br><span class="line">        _approve(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract UniswapV2Pair is IUniswapV2Pair, UniswapV2ERC20 &#123;</span><br><span class="line">    using SafeMath  for uint;</span><br><span class="line">    using UQ112x112 for uint224;</span><br><span class="line"></span><br><span class="line">    uint public constant MINIMUM_LIQUIDITY = 10**3;</span><br><span class="line">    bytes4 private constant SELECTOR = bytes4(keccak256(bytes(&#x27;transfer(address,uint256)&#x27;)));</span><br><span class="line"></span><br><span class="line">    address public factory;</span><br><span class="line">    address public token0;</span><br><span class="line">    address public token1;</span><br><span class="line"></span><br><span class="line">    uint112 private reserve0;           // uses single storage slot, accessible via getReserves</span><br><span class="line">    uint112 private reserve1;           // uses single storage slot, accessible via getReserves</span><br><span class="line">    uint32  private blockTimestampLast; // uses single storage slot, accessible via getReserves</span><br><span class="line"></span><br><span class="line">    uint public price0CumulativeLast;</span><br><span class="line">    uint public price1CumulativeLast;</span><br><span class="line">    uint public kLast; // reserve0 * reserve1, as of immediately after the most recent liquidity event</span><br><span class="line"></span><br><span class="line">    uint private unlocked = 1;</span><br><span class="line">    modifier lock() &#123;</span><br><span class="line">        require(unlocked == 1, &#x27;UniswapV2: LOCKED&#x27;);</span><br><span class="line">        unlocked = 0;</span><br><span class="line">        _;</span><br><span class="line">        unlocked = 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getReserves() public view returns (uint112 _reserve0, uint112 _reserve1, uint32 _blockTimestampLast) &#123;</span><br><span class="line">        _reserve0 = reserve0;</span><br><span class="line">        _reserve1 = reserve1;</span><br><span class="line">        _blockTimestampLast = blockTimestampLast;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _safeTransfer(address token, address to, uint value) private &#123;</span><br><span class="line">        (bool success, bytes memory data) = token.call(abi.encodeWithSelector(SELECTOR, to, value));</span><br><span class="line">        require(success &amp;&amp; (data.length == 0 || abi.decode(data, (bool))), &#x27;UniswapV2: TRANSFER_FAILED&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Mint(address indexed sender, uint amount0, uint amount1);</span><br><span class="line">    event Burn(address indexed sender, uint amount0, uint amount1, address indexed to);</span><br><span class="line">    event Swap(</span><br><span class="line">        address indexed sender,</span><br><span class="line">        uint amount0In,</span><br><span class="line">        uint amount1In,</span><br><span class="line">        uint amount0Out,</span><br><span class="line">        uint amount1Out,</span><br><span class="line">        address indexed to</span><br><span class="line">    );</span><br><span class="line">    event Sync(uint112 reserve0, uint112 reserve1);</span><br><span class="line"></span><br><span class="line">    constructor() public &#123;</span><br><span class="line">        factory = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // called once by the factory at time of deployment</span><br><span class="line">    function initialize(address _token0, address _token1) external &#123;</span><br><span class="line">        require(msg.sender == factory, &#x27;UniswapV2: FORBIDDEN&#x27;); // sufficient check</span><br><span class="line">        token0 = _token0;</span><br><span class="line">        token1 = _token1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // update reserves and, on the first call per block, price accumulators</span><br><span class="line">    function _update(uint balance0, uint balance1, uint112 _reserve0, uint112 _reserve1) private &#123;</span><br><span class="line">        require(balance0 &lt;= uint112(-1) &amp;&amp; balance1 &lt;= uint112(-1), &#x27;UniswapV2: OVERFLOW&#x27;);</span><br><span class="line">        uint32 blockTimestamp = uint32(block.timestamp % 2**32);</span><br><span class="line">        uint32 timeElapsed = blockTimestamp - blockTimestampLast; // overflow is desired</span><br><span class="line">        if (timeElapsed &gt; 0 &amp;&amp; _reserve0 != 0 &amp;&amp; _reserve1 != 0) &#123;</span><br><span class="line">            // * never overflows, and + overflow is desired</span><br><span class="line">            price0CumulativeLast += uint(UQ112x112.encode(_reserve1).uqdiv(_reserve0)) * timeElapsed;</span><br><span class="line">            price1CumulativeLast += uint(UQ112x112.encode(_reserve0).uqdiv(_reserve1)) * timeElapsed;</span><br><span class="line">        &#125;</span><br><span class="line">        reserve0 = uint112(balance0);</span><br><span class="line">        reserve1 = uint112(balance1);</span><br><span class="line">        blockTimestampLast = blockTimestamp;</span><br><span class="line">        emit Sync(reserve0, reserve1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // if fee is on, mint liquidity equivalent to 1/6th of the growth in sqrt(k)</span><br><span class="line">    function _mintFee(uint112 _reserve0, uint112 _reserve1) private returns (bool feeOn) &#123;</span><br><span class="line">        address feeTo = IUniswapV2Factory(factory).feeTo();</span><br><span class="line">        feeOn = feeTo != address(0);</span><br><span class="line">        uint _kLast = kLast; // gas savings</span><br><span class="line">        if (feeOn) &#123;</span><br><span class="line">            if (_kLast != 0) &#123;</span><br><span class="line">                uint rootK = Math.sqrt(uint(_reserve0).mul(_reserve1));</span><br><span class="line">                uint rootKLast = Math.sqrt(_kLast);</span><br><span class="line">                if (rootK &gt; rootKLast) &#123;</span><br><span class="line">                    uint numerator = totalSupply.mul(rootK.sub(rootKLast));</span><br><span class="line">                    uint denominator = rootK.mul(5).add(rootKLast);</span><br><span class="line">                    uint liquidity = numerator / denominator;</span><br><span class="line">                    if (liquidity &gt; 0) _mint(feeTo, liquidity);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (_kLast != 0) &#123;</span><br><span class="line">            kLast = 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // this low-level function should be called from a contract which performs important safety checks</span><br><span class="line">    function mint(address to) external lock returns (uint liquidity) &#123;</span><br><span class="line">        (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">        uint balance0 = IERC20(token0).balanceOf(address(this));</span><br><span class="line">        uint balance1 = IERC20(token1).balanceOf(address(this));</span><br><span class="line">        uint amount0 = balance0.sub(_reserve0);</span><br><span class="line">        uint amount1 = balance1.sub(_reserve1);</span><br><span class="line"></span><br><span class="line">        bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">        uint _totalSupply = totalSupply; // gas savings, must be defined here since totalSupply can update in _mintFee</span><br><span class="line">        if (_totalSupply == 0) &#123;</span><br><span class="line">            liquidity = Math.sqrt(amount0.mul(amount1)).sub(MINIMUM_LIQUIDITY);</span><br><span class="line">           _mint(address(0), MINIMUM_LIQUIDITY); // permanently lock the first MINIMUM_LIQUIDITY tokens</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            liquidity = Math.min(amount0.mul(_totalSupply) / _reserve0, amount1.mul(_totalSupply) / _reserve1);</span><br><span class="line">        &#125;</span><br><span class="line">        require(liquidity &gt; 0, &#x27;UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED&#x27;);</span><br><span class="line">        _mint(to, liquidity);</span><br><span class="line"></span><br><span class="line">        _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">        if (feeOn) kLast = uint(reserve0).mul(reserve1); // reserve0 and reserve1 are up-to-date</span><br><span class="line">        emit Mint(msg.sender, amount0, amount1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // this low-level function should be called from a contract which performs important safety checks</span><br><span class="line">    function burn(address to) external lock returns (uint amount0, uint amount1) &#123;</span><br><span class="line">        (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">        address _token0 = token0;                                // gas savings</span><br><span class="line">        address _token1 = token1;                                // gas savings</span><br><span class="line">        uint balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">        uint balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line">        uint liquidity = balanceOf[address(this)];</span><br><span class="line"></span><br><span class="line">        bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">        uint _totalSupply = totalSupply; // gas savings, must be defined here since totalSupply can update in _mintFee</span><br><span class="line">        amount0 = liquidity.mul(balance0) / _totalSupply; // using balances ensures pro-rata distribution</span><br><span class="line">        amount1 = liquidity.mul(balance1) / _totalSupply; // using balances ensures pro-rata distribution</span><br><span class="line">        require(amount0 &gt; 0 &amp;&amp; amount1 &gt; 0, &#x27;UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED&#x27;);</span><br><span class="line">        _burn(address(this), liquidity);</span><br><span class="line">        _safeTransfer(_token0, to, amount0);</span><br><span class="line">        _safeTransfer(_token1, to, amount1);</span><br><span class="line">        balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">        balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line"></span><br><span class="line">        _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">        if (feeOn) kLast = uint(reserve0).mul(reserve1); // reserve0 and reserve1 are up-to-date</span><br><span class="line">        emit Burn(msg.sender, amount0, amount1, to);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // this low-level function should be called from a contract which performs important safety checks</span><br><span class="line">    function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external lock &#123;</span><br><span class="line">        require(amount0Out &gt; 0 || amount1Out &gt; 0, &#x27;UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">        (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">        require(amount0Out &lt; _reserve0 &amp;&amp; amount1Out &lt; _reserve1, &#x27;UniswapV2: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line"></span><br><span class="line">        uint balance0;</span><br><span class="line">        uint balance1;</span><br><span class="line">        &#123; // scope for _token&#123;0,1&#125;, avoids stack too deep errors</span><br><span class="line">        address _token0 = token0;</span><br><span class="line">        address _token1 = token1;</span><br><span class="line">        require(to != _token0 &amp;&amp; to != _token1, &#x27;UniswapV2: INVALID_TO&#x27;);</span><br><span class="line">        if (amount0Out &gt; 0) _safeTransfer(_token0, to, amount0Out); // optimistically transfer tokens</span><br><span class="line">        if (amount1Out &gt; 0) _safeTransfer(_token1, to, amount1Out); // optimistically transfer tokens</span><br><span class="line">        if (data.length &gt; 0) IUniswapV2Callee(to).uniswapV2Call(msg.sender, amount0Out, amount1Out, data);</span><br><span class="line">        balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">        balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line">        &#125;</span><br><span class="line">        uint amount0In = balance0 &gt; _reserve0 - amount0Out ? balance0 - (_reserve0 - amount0Out) : 0;</span><br><span class="line">        uint amount1In = balance1 &gt; _reserve1 - amount1Out ? balance1 - (_reserve1 - amount1Out) : 0;</span><br><span class="line">        require(amount0In &gt; 0 || amount1In &gt; 0, &#x27;UniswapV2: INSUFFICIENT_INPUT_AMOUNT&#x27;);</span><br><span class="line">        &#123; // scope for reserve&#123;0,1&#125;Adjusted, avoids stack too deep errors</span><br><span class="line">        uint balance0Adjusted = balance0.mul(1000).sub(amount0In.mul(3));</span><br><span class="line">        uint balance1Adjusted = balance1.mul(1000).sub(amount1In.mul(3));</span><br><span class="line">        require(balance0Adjusted.mul(balance1Adjusted) &gt;= uint(_reserve0).mul(_reserve1).mul(1000**2), &#x27;UniswapV2: K&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">        emit Swap(msg.sender, amount0In, amount1In, amount0Out, amount1Out, to);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // force balances to match reserves</span><br><span class="line">    function skim(address to) external lock &#123;</span><br><span class="line">        address _token0 = token0; // gas savings</span><br><span class="line">        address _token1 = token1; // gas savings</span><br><span class="line">        _safeTransfer(_token0, to, IERC20(_token0).balanceOf(address(this)).sub(reserve0));</span><br><span class="line">        _safeTransfer(_token1, to, IERC20(_token1).balanceOf(address(this)).sub(reserve1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // force reserves to match balances</span><br><span class="line">    function sync() external lock &#123;</span><br><span class="line">        _update(IERC20(token0).balanceOf(address(this)), IERC20(token1).balanceOf(address(this)), reserve0, reserve1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract UniswapV2Factory is IUniswapV2Factory &#123;</span><br><span class="line">    address public feeTo;</span><br><span class="line">    address public feeToSetter;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; address)) public getPair;</span><br><span class="line">    address[] public allPairs;</span><br><span class="line"></span><br><span class="line">    event PairCreated(address indexed token0, address indexed token1, address pair, uint);</span><br><span class="line"></span><br><span class="line">    constructor(address _feeToSetter) public &#123;</span><br><span class="line">        feeToSetter = _feeToSetter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allPairsLength() external view returns (uint) &#123;</span><br><span class="line">        return allPairs.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function createPair(address tokenA, address tokenB) external returns (address pair) &#123;</span><br><span class="line">        require(tokenA != tokenB, &#x27;UniswapV2: IDENTICAL_ADDRESSES&#x27;);</span><br><span class="line">        (address token0, address token1) = tokenA &lt; tokenB ? (tokenA, tokenB) : (tokenB, tokenA);</span><br><span class="line">        require(token0 != address(0), &#x27;UniswapV2: ZERO_ADDRESS&#x27;);</span><br><span class="line">        require(getPair[token0][token1] == address(0), &#x27;UniswapV2: PAIR_EXISTS&#x27;); // single check is sufficient</span><br><span class="line">        bytes memory bytecode = type(UniswapV2Pair).creationCode;</span><br><span class="line">        bytes32 salt = keccak256(abi.encodePacked(token0, token1));</span><br><span class="line">        assembly &#123;</span><br><span class="line">            pair := create2(0, add(bytecode, 32), mload(bytecode), salt)</span><br><span class="line">        &#125;</span><br><span class="line">        IUniswapV2Pair(pair).initialize(token0, token1);</span><br><span class="line">        getPair[token0][token1] = pair;</span><br><span class="line">        getPair[token1][token0] = pair; // populate mapping in the reverse direction</span><br><span class="line">        allPairs.push(pair);</span><br><span class="line">        emit PairCreated(token0, token1, pair, allPairs.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setFeeTo(address _feeTo) external &#123;</span><br><span class="line">        require(msg.sender == feeToSetter, &#x27;UniswapV2: FORBIDDEN&#x27;);</span><br><span class="line">        feeTo = _feeTo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setFeeToSetter(address _feeToSetter) external &#123;</span><br><span class="line">        require(msg.sender == feeToSetter, &#x27;UniswapV2: FORBIDDEN&#x27;);</span><br><span class="line">        feeToSetter = _feeToSetter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// a library for performing overflow-safe math, courtesy of DappHub (https://github.com/dapphub/ds-math)</span><br><span class="line"></span><br><span class="line">library SafeMath &#123;</span><br><span class="line">    function add(uint x, uint y) internal pure returns (uint z) &#123;</span><br><span class="line">        require((z = x + y) &gt;= x, &#x27;ds-math-add-overflow&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sub(uint x, uint y) internal pure returns (uint z) &#123;</span><br><span class="line">        require((z = x - y) &lt;= x, &#x27;ds-math-sub-underflow&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mul(uint x, uint y) internal pure returns (uint z) &#123;</span><br><span class="line">        require(y == 0 || (z = x * y) / y == x, &#x27;ds-math-mul-overflow&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// a library for performing various math operations</span><br><span class="line"></span><br><span class="line">library Math &#123;</span><br><span class="line">    function min(uint x, uint y) internal pure returns (uint z) &#123;</span><br><span class="line">        z = x &lt; y ? x : y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // babylonian method (https://en.wikipedia.org/wiki/Methods_of_computing_square_roots#Babylonian_method)</span><br><span class="line">    function sqrt(uint y) internal pure returns (uint z) &#123;</span><br><span class="line">        if (y &gt; 3) &#123;</span><br><span class="line">            z = y;</span><br><span class="line">            uint x = y / 2 + 1;</span><br><span class="line">            while (x &lt; z) &#123;</span><br><span class="line">                z = x;</span><br><span class="line">                x = (y / x + x) / 2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (y != 0) &#123;</span><br><span class="line">            z = 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">library UQ112x112 &#123;</span><br><span class="line">    uint224 constant Q112 = 2**112;</span><br><span class="line"></span><br><span class="line">    // encode a uint112 as a UQ112x112</span><br><span class="line">    function encode(uint112 y) internal pure returns (uint224 z) &#123;</span><br><span class="line">        z = uint224(y) * Q112; // never overflows</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // divide a UQ112x112 by a uint112, returning a UQ112x112</span><br><span class="line">    function uqdiv(uint224 x, uint112 y) internal pure returns (uint224 z) &#123;</span><br><span class="line">        z = x / uint224(y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UniswapV2ERC20"><a href="#UniswapV2ERC20" class="headerlink" title="UniswapV2ERC20"></a>UniswapV2ERC20</h2><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">contract UniswapV2ERC20 is IUniswapV2ERC20 &#123;</span><br><span class="line">    using SafeMath for uint;</span><br><span class="line"></span><br><span class="line">    string public constant name = &#x27;Uniswap V2&#x27;;</span><br><span class="line">    string public constant symbol = &#x27;UNI-V2&#x27;;</span><br><span class="line">    uint8 public constant decimals = 18;</span><br><span class="line">    uint  public totalSupply;</span><br><span class="line">    mapping(address =&gt; uint) public balanceOf;</span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; uint)) public allowance;</span><br><span class="line"></span><br><span class="line">    bytes32 public DOMAIN_SEPARATOR;</span><br><span class="line">    // keccak256(&quot;Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;);</span><br><span class="line">    bytes32 public constant PERMIT_TYPEHASH = 0x6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c9;</span><br><span class="line">    mapping(address =&gt; uint) public nonces;</span><br><span class="line"></span><br><span class="line">    event Approval(address indexed owner, address indexed spender, uint value);</span><br><span class="line">    event Transfer(address indexed from, address indexed to, uint value);</span><br><span class="line"></span><br><span class="line">    constructor() public &#123;</span><br><span class="line">        uint chainId;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            chainId := chainid</span><br><span class="line">        &#125;</span><br><span class="line">        DOMAIN_SEPARATOR = keccak256(</span><br><span class="line">            abi.encode(</span><br><span class="line">                keccak256(&#x27;EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)&#x27;),</span><br><span class="line">                keccak256(bytes(name)),</span><br><span class="line">                keccak256(bytes(&#x27;1&#x27;)),</span><br><span class="line">                chainId,</span><br><span class="line">                address(this)</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _mint(address to, uint value) internal &#123;</span><br><span class="line">        totalSupply = totalSupply.add(value);</span><br><span class="line">        balanceOf[to] = balanceOf[to].add(value);</span><br><span class="line">        emit Transfer(address(0), to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _burn(address from, uint value) internal &#123;</span><br><span class="line">        balanceOf[from] = balanceOf[from].sub(value);</span><br><span class="line">        totalSupply = totalSupply.sub(value);</span><br><span class="line">        emit Transfer(from, address(0), value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _approve(address owner, address spender, uint value) private &#123;</span><br><span class="line">        allowance[owner][spender] = value;</span><br><span class="line">        emit Approval(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _transfer(address from, address to, uint value) private &#123;</span><br><span class="line">        balanceOf[from] = balanceOf[from].sub(value);</span><br><span class="line">        balanceOf[to] = balanceOf[to].add(value);</span><br><span class="line">        emit Transfer(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function approve(address spender, uint value) external returns (bool) &#123;</span><br><span class="line">        _approve(msg.sender, spender, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address to, uint value) external returns (bool) &#123;</span><br><span class="line">        _transfer(msg.sender, to, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transferFrom(address from, address to, uint value) external returns (bool) &#123;</span><br><span class="line">        if (allowance[from][msg.sender] != uint(-1)) &#123;</span><br><span class="line">            allowance[from][msg.sender] = allowance[from][msg.sender].sub(value);</span><br><span class="line">        &#125;</span><br><span class="line">        _transfer(from, to, value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function permit(address owner, address spender, uint value, uint deadline, uint8 v, bytes32 r, bytes32 s) external &#123;</span><br><span class="line">        require(deadline &gt;= block.timestamp, &#x27;UniswapV2: EXPIRED&#x27;);</span><br><span class="line">        bytes32 digest = keccak256(</span><br><span class="line">            abi.encodePacked(</span><br><span class="line">                &#x27;\x19\x01&#x27;,</span><br><span class="line">                DOMAIN_SEPARATOR,</span><br><span class="line">                keccak256(abi.encode(PERMIT_TYPEHASH, owner, spender, value, nonces[owner]++, deadline))</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        address recoveredAddress = ecrecover(digest, v, r, s);</span><br><span class="line">        require(recoveredAddress != address(0) &amp;&amp; recoveredAddress == owner, &#x27;UniswapV2: INVALID_SIGNATURE&#x27;);</span><br><span class="line">        _approve(owner, spender, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Analyse"><a href="#Analyse" class="headerlink" title="Analyse"></a>Analyse</h3><p><strong>UniswapV2ERC20å°±æ˜¯ç®€å•çš„ERC20åˆçº¦ï¼Œåªä¸è¿‡å¤šäº†ä¸€ä¸ªpermitå…è®¸ç”¨ç­¾åæ¥å®Œæˆapproveè€Œå·²</strong></p>
<h2 id="UniswapV2Pair"><a href="#UniswapV2Pair" class="headerlink" title="UniswapV2Pair"></a>UniswapV2Pair</h2><h3 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line">contract UniswapV2Pair is IUniswapV2Pair, UniswapV2ERC20 &#123;</span><br><span class="line">    using SafeMath  for uint;</span><br><span class="line">    using UQ112x112 for uint224;</span><br><span class="line"></span><br><span class="line">    uint public constant MINIMUM_LIQUIDITY = 10**3;</span><br><span class="line">    bytes4 private constant SELECTOR = bytes4(keccak256(bytes(&#x27;transfer(address,uint256)&#x27;)));</span><br><span class="line"></span><br><span class="line">    address public factory;</span><br><span class="line">    address public token0;</span><br><span class="line">    address public token1;</span><br><span class="line"></span><br><span class="line">    uint112 private reserve0;           // uses single storage slot, accessible via getReserves</span><br><span class="line">    uint112 private reserve1;           // uses single storage slot, accessible via getReserves</span><br><span class="line">    uint32  private blockTimestampLast; // uses single storage slot, accessible via getReserves</span><br><span class="line"></span><br><span class="line">    uint public price0CumulativeLast;</span><br><span class="line">    uint public price1CumulativeLast;</span><br><span class="line">    uint public kLast; // reserve0 * reserve1, as of immediately after the most recent liquidity event</span><br><span class="line"></span><br><span class="line">    uint private unlocked = 1;</span><br><span class="line">    modifier lock() &#123;</span><br><span class="line">        require(unlocked == 1, &#x27;UniswapV2: LOCKED&#x27;);</span><br><span class="line">        unlocked = 0;</span><br><span class="line">        _;</span><br><span class="line">        unlocked = 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getReserves() public view returns (uint112 _reserve0, uint112 _reserve1, uint32 _blockTimestampLast) &#123;</span><br><span class="line">        _reserve0 = reserve0;</span><br><span class="line">        _reserve1 = reserve1;</span><br><span class="line">        _blockTimestampLast = blockTimestampLast;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _safeTransfer(address token, address to, uint value) private &#123;</span><br><span class="line">        (bool success, bytes memory data) = token.call(abi.encodeWithSelector(SELECTOR, to, value));</span><br><span class="line">        require(success &amp;&amp; (data.length == 0 || abi.decode(data, (bool))), &#x27;UniswapV2: TRANSFER_FAILED&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event Mint(address indexed sender, uint amount0, uint amount1);</span><br><span class="line">    event Burn(address indexed sender, uint amount0, uint amount1, address indexed to);</span><br><span class="line">    event Swap(</span><br><span class="line">        address indexed sender,</span><br><span class="line">        uint amount0In,</span><br><span class="line">        uint amount1In,</span><br><span class="line">        uint amount0Out,</span><br><span class="line">        uint amount1Out,</span><br><span class="line">        address indexed to</span><br><span class="line">    );</span><br><span class="line">    event Sync(uint112 reserve0, uint112 reserve1);</span><br><span class="line"></span><br><span class="line">    constructor() public &#123;</span><br><span class="line">        factory = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // called once by the factory at time of deployment</span><br><span class="line">    function initialize(address _token0, address _token1) external &#123;</span><br><span class="line">        require(msg.sender == factory, &#x27;UniswapV2: FORBIDDEN&#x27;); // sufficient check</span><br><span class="line">        token0 = _token0;</span><br><span class="line">        token1 = _token1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // update reserves and, on the first call per block, price accumulators</span><br><span class="line">    function _update(uint balance0, uint balance1, uint112 _reserve0, uint112 _reserve1) private &#123;</span><br><span class="line">        require(balance0 &lt;= uint112(-1) &amp;&amp; balance1 &lt;= uint112(-1), &#x27;UniswapV2: OVERFLOW&#x27;);</span><br><span class="line">        uint32 blockTimestamp = uint32(block.timestamp % 2**32);</span><br><span class="line">        uint32 timeElapsed = blockTimestamp - blockTimestampLast; // overflow is desired</span><br><span class="line">        if (timeElapsed &gt; 0 &amp;&amp; _reserve0 != 0 &amp;&amp; _reserve1 != 0) &#123;</span><br><span class="line">            // * never overflows, and + overflow is desired</span><br><span class="line">            price0CumulativeLast += uint(UQ112x112.encode(_reserve1).uqdiv(_reserve0)) * timeElapsed;</span><br><span class="line">            price1CumulativeLast += uint(UQ112x112.encode(_reserve0).uqdiv(_reserve1)) * timeElapsed;</span><br><span class="line">        &#125;</span><br><span class="line">        reserve0 = uint112(balance0);</span><br><span class="line">        reserve1 = uint112(balance1);</span><br><span class="line">        blockTimestampLast = blockTimestamp;</span><br><span class="line">        emit Sync(reserve0, reserve1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // if fee is on, mint liquidity equivalent to 1/6th of the growth in sqrt(k)</span><br><span class="line">    function _mintFee(uint112 _reserve0, uint112 _reserve1) private returns (bool feeOn) &#123;</span><br><span class="line">        address feeTo = IUniswapV2Factory(factory).feeTo();</span><br><span class="line">        feeOn = feeTo != address(0);</span><br><span class="line">        uint _kLast = kLast; // gas savings</span><br><span class="line">        if (feeOn) &#123;</span><br><span class="line">            if (_kLast != 0) &#123;</span><br><span class="line">                uint rootK = Math.sqrt(uint(_reserve0).mul(_reserve1));</span><br><span class="line">                uint rootKLast = Math.sqrt(_kLast);</span><br><span class="line">                if (rootK &gt; rootKLast) &#123;</span><br><span class="line">                    uint numerator = totalSupply.mul(rootK.sub(rootKLast));</span><br><span class="line">                    uint denominator = rootK.mul(5).add(rootKLast);</span><br><span class="line">                    uint liquidity = numerator / denominator;</span><br><span class="line">                    if (liquidity &gt; 0) _mint(feeTo, liquidity);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (_kLast != 0) &#123;</span><br><span class="line">            kLast = 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // this low-level function should be called from a contract which performs important safety checks</span><br><span class="line">    function mint(address to) external lock returns (uint liquidity) &#123;</span><br><span class="line">        (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">        uint balance0 = IERC20(token0).balanceOf(address(this));</span><br><span class="line">        uint balance1 = IERC20(token1).balanceOf(address(this));</span><br><span class="line">        uint amount0 = balance0.sub(_reserve0);</span><br><span class="line">        uint amount1 = balance1.sub(_reserve1);</span><br><span class="line"></span><br><span class="line">        bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">        uint _totalSupply = totalSupply; // gas savings, must be defined here since totalSupply can update in _mintFee</span><br><span class="line">        if (_totalSupply == 0) &#123;</span><br><span class="line">            liquidity = Math.sqrt(amount0.mul(amount1)).sub(MINIMUM_LIQUIDITY);</span><br><span class="line">           _mint(address(0), MINIMUM_LIQUIDITY); // permanently lock the first MINIMUM_LIQUIDITY tokens</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            liquidity = Math.min(amount0.mul(_totalSupply) / _reserve0, amount1.mul(_totalSupply) / _reserve1);</span><br><span class="line">        &#125;</span><br><span class="line">        require(liquidity &gt; 0, &#x27;UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED&#x27;);</span><br><span class="line">        _mint(to, liquidity);</span><br><span class="line"></span><br><span class="line">        _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">        if (feeOn) kLast = uint(reserve0).mul(reserve1); // reserve0 and reserve1 are up-to-date</span><br><span class="line">        emit Mint(msg.sender, amount0, amount1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // this low-level function should be called from a contract which performs important safety checks</span><br><span class="line">    function burn(address to) external lock returns (uint amount0, uint amount1) &#123;</span><br><span class="line">        (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">        address _token0 = token0;                                // gas savings</span><br><span class="line">        address _token1 = token1;                                // gas savings</span><br><span class="line">        uint balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">        uint balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line">        uint liquidity = balanceOf[address(this)];</span><br><span class="line"></span><br><span class="line">        bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">        uint _totalSupply = totalSupply; // gas savings, must be defined here since totalSupply can update in _mintFee</span><br><span class="line">        amount0 = liquidity.mul(balance0) / _totalSupply; // using balances ensures pro-rata distribution</span><br><span class="line">        amount1 = liquidity.mul(balance1) / _totalSupply; // using balances ensures pro-rata distribution</span><br><span class="line">        require(amount0 &gt; 0 &amp;&amp; amount1 &gt; 0, &#x27;UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED&#x27;);</span><br><span class="line">        _burn(address(this), liquidity);</span><br><span class="line">        _safeTransfer(_token0, to, amount0);</span><br><span class="line">        _safeTransfer(_token1, to, amount1);</span><br><span class="line">        balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">        balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line"></span><br><span class="line">        _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">        if (feeOn) kLast = uint(reserve0).mul(reserve1); // reserve0 and reserve1 are up-to-date</span><br><span class="line">        emit Burn(msg.sender, amount0, amount1, to);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // this low-level function should be called from a contract which performs important safety checks</span><br><span class="line">    function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external lock &#123;</span><br><span class="line">        require(amount0Out &gt; 0 || amount1Out &gt; 0, &#x27;UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">        (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">        require(amount0Out &lt; _reserve0 &amp;&amp; amount1Out &lt; _reserve1, &#x27;UniswapV2: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line"></span><br><span class="line">        uint balance0;</span><br><span class="line">        uint balance1;</span><br><span class="line">        &#123; // scope for _token&#123;0,1&#125;, avoids stack too deep errors</span><br><span class="line">        address _token0 = token0;</span><br><span class="line">        address _token1 = token1;</span><br><span class="line">        require(to != _token0 &amp;&amp; to != _token1, &#x27;UniswapV2: INVALID_TO&#x27;);</span><br><span class="line">        if (amount0Out &gt; 0) _safeTransfer(_token0, to, amount0Out); // optimistically transfer tokens</span><br><span class="line">        if (amount1Out &gt; 0) _safeTransfer(_token1, to, amount1Out); // optimistically transfer tokens</span><br><span class="line">        if (data.length &gt; 0) IUniswapV2Callee(to).uniswapV2Call(msg.sender, amount0Out, amount1Out, data);</span><br><span class="line">        balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">        balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line">        &#125;</span><br><span class="line">        uint amount0In = balance0 &gt; _reserve0 - amount0Out ? balance0 - (_reserve0 - amount0Out) : 0;</span><br><span class="line">        uint amount1In = balance1 &gt; _reserve1 - amount1Out ? balance1 - (_reserve1 - amount1Out) : 0;</span><br><span class="line">        require(amount0In &gt; 0 || amount1In &gt; 0, &#x27;UniswapV2: INSUFFICIENT_INPUT_AMOUNT&#x27;);</span><br><span class="line">        &#123; // scope for reserve&#123;0,1&#125;Adjusted, avoids stack too deep errors</span><br><span class="line">        uint balance0Adjusted = balance0.mul(1000).sub(amount0In.mul(3));</span><br><span class="line">        uint balance1Adjusted = balance1.mul(1000).sub(amount1In.mul(3));</span><br><span class="line">        require(balance0Adjusted.mul(balance1Adjusted) &gt;= uint(_reserve0).mul(_reserve1).mul(1000**2), &#x27;UniswapV2: K&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">        emit Swap(msg.sender, amount0In, amount1In, amount0Out, amount1Out, to);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // force balances to match reserves</span><br><span class="line">    function skim(address to) external lock &#123;</span><br><span class="line">        address _token0 = token0; // gas savings</span><br><span class="line">        address _token1 = token1; // gas savings</span><br><span class="line">        _safeTransfer(_token0, to, IERC20(_token0).balanceOf(address(this)).sub(reserve0));</span><br><span class="line">        _safeTransfer(_token1, to, IERC20(_token1).balanceOf(address(this)).sub(reserve1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // force reserves to match balances</span><br><span class="line">    function sync() external lock &#123;</span><br><span class="line">        _update(IERC20(token0).balanceOf(address(this)), IERC20(token1).balanceOf(address(this)), reserve0, reserve1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Analyse-1"><a href="#Analyse-1" class="headerlink" title="Analyse"></a>Analyse</h3><p><strong>pairä¹Ÿæ˜¯ä¸€ä¸ªERC20åˆçº¦ï¼Œæ˜¯ç”¨æ¥è¿›è¡Œtoken0ä¸token1çš„äº¤æ¢ï¼Œä¸€èˆ¬ç”±Factoryåˆçº¦æ¥åˆ›å»ºï¼Œç„¶ååˆå§‹åŒ–ä¸¤ç§token</strong></p>
<h3 id="getReserves"><a href="#getReserves" class="headerlink" title="getReserves()"></a>getReserves()</h3><p><strong>ç”¨äºå¾—åˆ°ä¸¤ä»£å¸çš„å‚¨è“„é‡‘ä½™é¢</strong></p>
<h3 id="initialize-address-token0-address-token1"><a href="#initialize-address-token0-address-token1" class="headerlink" title="initialize(address _token0, address _token1)"></a>initialize(address _token0, address _token1)</h3><p><strong>ç”¨äºåˆå§‹åŒ–token0ä¸token1</strong></p>
<h3 id="updata-uint-balance0-uint-balance1-uint112-reserve0-uint112-reserve1"><a href="#updata-uint-balance0-uint-balance1-uint112-reserve0-uint112-reserve1" class="headerlink" title="_updata(uint balance0, uint balance1, uint112 _reserve0, uint112 _reserve1)"></a>_updata(uint balance0, uint balance1, uint112 _reserve0, uint112 _reserve1)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function _update(uint balance0, uint balance1, uint112 _reserve0, uint112 _reserve1) private &#123;</span><br><span class="line">    require(balance0 &lt;= uint112(-1) &amp;&amp; balance1 &lt;= uint112(-1), &#x27;UniswapV2: OVERFLOW&#x27;);</span><br><span class="line">    uint32 blockTimestamp = uint32(block.timestamp % 2**32);</span><br><span class="line">    uint32 timeElapsed = blockTimestamp - blockTimestampLast; // overflow is desired</span><br><span class="line">    if (timeElapsed &gt; 0 &amp;&amp; _reserve0 != 0 &amp;&amp; _reserve1 != 0) &#123;</span><br><span class="line">        // * never overflows, and + overflow is desired</span><br><span class="line">        price0CumulativeLast += uint(UQ112x112.encode(_reserve1).uqdiv(_reserve0)) * timeElapsed;</span><br><span class="line">        price1CumulativeLast += uint(UQ112x112.encode(_reserve0).uqdiv(_reserve1)) * timeElapsed;</span><br><span class="line">    &#125;</span><br><span class="line">    reserve0 = uint112(balance0);</span><br><span class="line">    reserve1 = uint112(balance1);</span><br><span class="line">    blockTimestampLast = blockTimestamp;</span><br><span class="line">    emit Sync(reserve0, reserve1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç”¨äºæ›´æ–°å‚¨å¤‡é‡‘çš„ä½™é¢ï¼Œä¸balanceä¿æŒä¸€è‡´</strong></p>
<h3 id="mint-to"><a href="#mint-to" class="headerlink" title="mint(to)"></a>mint(to)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function mint(address to) external lock returns (uint liquidity) &#123;</span><br><span class="line">    (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">    uint balance0 = IERC20(token0).balanceOf(address(this));</span><br><span class="line">    uint balance1 = IERC20(token1).balanceOf(address(this));</span><br><span class="line">    uint amount0 = balance0.sub(_reserve0);</span><br><span class="line">    uint amount1 = balance1.sub(_reserve1);</span><br><span class="line"></span><br><span class="line">    bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">    uint _totalSupply = totalSupply; // gas savings, must be defined here since totalSupply can update in _mintFee</span><br><span class="line">    if (_totalSupply == 0) &#123;</span><br><span class="line">        liquidity = Math.sqrt(amount0.mul(amount1)).sub(MINIMUM_LIQUIDITY);</span><br><span class="line">       _mint(address(0), MINIMUM_LIQUIDITY); // permanently lock the first MINIMUM_LIQUIDITY tokens</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        liquidity = Math.min(amount0.mul(_totalSupply) / _reserve0, amount1.mul(_totalSupply) / _reserve1);</span><br><span class="line">    &#125;</span><br><span class="line">    require(liquidity &gt; 0, &#x27;UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED&#x27;);</span><br><span class="line">    _mint(to, liquidity);</span><br><span class="line"></span><br><span class="line">    _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">    if (feeOn) kLast = uint(reserve0).mul(reserve1); // reserve0 and reserve1 are up-to-date</span><br><span class="line">    emit Mint(msg.sender, amount0, amount1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç”¨äºç»™pairåˆçº¦æ·»åŠ æµåŠ¨æ€§ï¼Œè¿”è¿˜ç»™é“¸é€ è€…pairçš„è‡ªèº«ä»£å¸ã€‚é“¸é€ è¿‡ç¨‹éœ€è¦è‡ªè¡Œå‘æ± å­è½¬è´¦token0ä¸token1,ç„¶åæ± å­ä¼šæ ¹æ®åŸæœ¬çš„å‚¨è“„é‡‘ä¸çœŸæ­£çš„åœ°å€ä½™é¢æ¥è®¡ç®—å‡ºä½ è½¬è´¦çš„token0,1çš„æ•°é‡ï¼Œç„¶ååˆ¤æ–­æ± å­çš„totalSupplyæ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ä¼šç»™address(0)é“¸é€ 1000ä¸ªLptoken,ç„¶åå†ç»™é“¸é€ è€…é“¸é€ ä¸¤ç§ä»£å¸ä¹˜ç§¯çš„å¼€æ–¹æ•°é‡çš„Lptokenã€‚å¦‚æœä¸ä¸º0ï¼Œé‚£ä¹ˆå°±ä¼šé“¸é€ ä¸¤ä»£å¸ä¸­æ•°é‡æœ€å°‘çš„token,æ•°é‡ç»è¿‡æ¯”ä¾‹è®¡ç®—å¾—å‡ºã€‚ç„¶åæ›´æ–°å‚¨è“„é‡‘</strong>ã€‚</p>
<h3 id="mintFee-uint112-reserve0-uint112-reserve1"><a href="#mintFee-uint112-reserve0-uint112-reserve1" class="headerlink" title="_mintFee(uint112 _reserve0, uint112 _reserve1)"></a>_mintFee(uint112 _reserve0, uint112 _reserve1)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function _mintFee(uint112 _reserve0, uint112 _reserve1) private returns (bool feeOn) &#123;</span><br><span class="line">    address feeTo = IUniswapV2Factory(factory).feeTo();</span><br><span class="line">    feeOn = feeTo != address(0);</span><br><span class="line">    uint _kLast = kLast; // gas savings</span><br><span class="line">    if (feeOn) &#123;</span><br><span class="line">        if (_kLast != 0) &#123;</span><br><span class="line">            uint rootK = Math.sqrt(uint(_reserve0).mul(_reserve1));</span><br><span class="line">            uint rootKLast = Math.sqrt(_kLast);</span><br><span class="line">            if (rootK &gt; rootKLast) &#123;</span><br><span class="line">                uint numerator = totalSupply.mul(rootK.sub(rootKLast));</span><br><span class="line">                uint denominator = rootK.mul(5).add(rootKLast);</span><br><span class="line">                uint liquidity = numerator / denominator;</span><br><span class="line">                if (liquidity &gt; 0) _mint(feeTo, liquidity);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if (_kLast != 0) &#123;</span><br><span class="line">        kLast = 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è®¡ç®—å‡ºå‡ ä¹1&#x2F;6çš„totalSupplyé“¸é€ ç»™feeToåœ°å€</strong></p>
<h3 id="burn-to"><a href="#burn-to" class="headerlink" title="burn(to)"></a>burn(to)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">function burn(address to) external lock returns (uint amount0, uint amount1) &#123;</span><br><span class="line">    (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">    address _token0 = token0;                                // gas savings</span><br><span class="line">    address _token1 = token1;                                // gas savings</span><br><span class="line">    uint balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">    uint balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line">    uint liquidity = balanceOf[address(this)];</span><br><span class="line"></span><br><span class="line">    bool feeOn = _mintFee(_reserve0, _reserve1);</span><br><span class="line">    uint _totalSupply = totalSupply; // gas savings, must be defined here since totalSupply can update in _mintFee</span><br><span class="line">    amount0 = liquidity.mul(balance0) / _totalSupply; // using balances ensures pro-rata distribution</span><br><span class="line">    amount1 = liquidity.mul(balance1) / _totalSupply; // using balances ensures pro-rata distribution</span><br><span class="line">    require(amount0 &gt; 0 &amp;&amp; amount1 &gt; 0, &#x27;UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED&#x27;);</span><br><span class="line">    _burn(address(this), liquidity);</span><br><span class="line">    _safeTransfer(_token0, to, amount0);</span><br><span class="line">    _safeTransfer(_token1, to, amount1);</span><br><span class="line">    balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">    balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line"></span><br><span class="line">    _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">    if (feeOn) kLast = uint(reserve0).mul(reserve1); // reserve0 and reserve1 are up-to-date</span><br><span class="line">    emit Burn(msg.sender, amount0, amount1, to);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è®¡ç®—å‡ºå‡ºç›¸å¯¹æ¯”ä¾‹çš„token0,1.ç„¶åè½¬ç»™é”€æ¯è€…ï¼ŒæµåŠ¨æ€§çš„æ•°é‡éœ€è¦é”€æ¯è€…è‡ªè¡Œè½¬è´¦ç»™æœ¬åœ°å€,ç„¶åæ ¹æ®æœ¬åœ°å€çš„lptokenæ¥è®¡ç®—ã€‚ç„¶åæ›´æ–°å‚¨è“„é‡‘</strong></p>
<h3 id="swap-uint-amount0Out-uint-amount1Out-address-to-bytes-calldata-data"><a href="#swap-uint-amount0Out-uint-amount1Out-address-to-bytes-calldata-data" class="headerlink" title="swap(uint amount0Out, uint amount1Out, address to, bytes calldata data)"></a>swap(uint amount0Out, uint amount1Out, address to, bytes calldata data)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external lock &#123;</span><br><span class="line">      require(amount0Out &gt; 0 || amount1Out &gt; 0, &#x27;UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">      (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings</span><br><span class="line">      require(amount0Out &lt; _reserve0 &amp;&amp; amount1Out &lt; _reserve1, &#x27;UniswapV2: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line"></span><br><span class="line">      uint balance0;</span><br><span class="line">      uint balance1;</span><br><span class="line">      &#123; // scope for _token&#123;0,1&#125;, avoids stack too deep errors</span><br><span class="line">      address _token0 = token0;</span><br><span class="line">      address _token1 = token1;</span><br><span class="line">      require(to != _token0 &amp;&amp; to != _token1, &#x27;UniswapV2: INVALID_TO&#x27;);</span><br><span class="line">      if (amount0Out &gt; 0) _safeTransfer(_token0, to, amount0Out); // optimistically transfer tokens</span><br><span class="line">      if (amount1Out &gt; 0) _safeTransfer(_token1, to, amount1Out); // optimistically transfer tokens</span><br><span class="line">      if (data.length &gt; 0) IUniswapV2Callee(to).uniswapV2Call(msg.sender, amount0Out, amount1Out, data);</span><br><span class="line">      balance0 = IERC20(_token0).balanceOf(address(this));</span><br><span class="line">      balance1 = IERC20(_token1).balanceOf(address(this));</span><br><span class="line">      &#125;</span><br><span class="line">      uint amount0In = balance0 &gt; _reserve0 - amount0Out ? balance0 - (_reserve0 - amount0Out) : 0;</span><br><span class="line">      uint amount1In = balance1 &gt; _reserve1 - amount1Out ? balance1 - (_reserve1 - amount1Out) : 0;</span><br><span class="line">      require(amount0In &gt; 0 || amount1In &gt; 0, &#x27;UniswapV2: INSUFFICIENT_INPUT_AMOUNT&#x27;);</span><br><span class="line">      &#123; // scope for reserve&#123;0,1&#125;Adjusted, avoids stack too deep errors</span><br><span class="line">      uint balance0Adjusted = balance0.mul(1000).sub(amount0In.mul(3));</span><br><span class="line">      uint balance1Adjusted = balance1.mul(1000).sub(amount1In.mul(3));</span><br><span class="line">      require(balance0Adjusted.mul(balance1Adjusted) &gt;= uint(_reserve0).mul(_reserve1).mul(1000**2), &#x27;UniswapV2: K&#x27;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      _update(balance0, balance1, _reserve0, _reserve1);</span><br><span class="line">      emit Swap(msg.sender, amount0In, amount1In, amount0Out, amount1Out, to);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å…ˆå¾—åˆ°ä¸€å®šæ•°é‡çš„amount0,1ã€‚ç„¶ååˆ¤æ–­dataæ˜¯å¦å¤§äº0ï¼Œæ¥åˆ¤æ–­æ˜¯å¦è¿›è¡Œå›è°ƒtoåˆçº¦ã€‚æœ€ååˆ¤æ–­äº¤æ¢å‰åæ± ä¸­token0*token1çš„å®šå€¼kæ˜¯å¦å˜å¤§ï¼Œè‹¥å˜å¤§æ­£å¸¸ï¼Œè‹¥å˜å°å›å½’ã€‚åŒæ—¶éœ€è¦æ”¶å–3&#x2F;1000çš„amountInçš„æ‰‹ç»­è´¹ï¼Œå…ˆæ”¶è´¹ååˆ¤æ–­å®šå€¼kã€‚ç„¶åæ›´æ–°å‚¨è“„é‡‘</strong></p>
<h3 id="skim-address-to"><a href="#skim-address-to" class="headerlink" title="skim(address to)"></a>skim(address to)</h3><p><strong>å¼ºåˆ¶è®©balanceä¸å‚¨è“„é‡‘ç›¸ç­‰</strong></p>
<h3 id="syncï¼ˆaddress-toï¼‰"><a href="#syncï¼ˆaddress-toï¼‰" class="headerlink" title="syncï¼ˆaddress toï¼‰"></a>syncï¼ˆaddress toï¼‰</h3><p><strong>å¼ºåˆ¶è®©å‚¨è“„é‡‘ä¸balanceç›¸ç­‰</strong></p>
<h2 id="UniswapV2Factory"><a href="#UniswapV2Factory" class="headerlink" title="UniswapV2Factory"></a>UniswapV2Factory</h2><h3 id="Code-2"><a href="#Code-2" class="headerlink" title="Code"></a>Code</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">contract UniswapV2Factory is IUniswapV2Factory &#123;</span><br><span class="line">    address public feeTo;</span><br><span class="line">    address public feeToSetter;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; mapping(address =&gt; address)) public getPair;</span><br><span class="line">    address[] public allPairs;</span><br><span class="line"></span><br><span class="line">    event PairCreated(address indexed token0, address indexed token1, address pair, uint);</span><br><span class="line"></span><br><span class="line">    constructor(address _feeToSetter) public &#123;</span><br><span class="line">        feeToSetter = _feeToSetter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allPairsLength() external view returns (uint) &#123;</span><br><span class="line">        return allPairs.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function createPair(address tokenA, address tokenB) external returns (address pair) &#123;</span><br><span class="line">        require(tokenA != tokenB, &#x27;UniswapV2: IDENTICAL_ADDRESSES&#x27;);</span><br><span class="line">        (address token0, address token1) = tokenA &lt; tokenB ? (tokenA, tokenB) : (tokenB, tokenA);</span><br><span class="line">        require(token0 != address(0), &#x27;UniswapV2: ZERO_ADDRESS&#x27;);</span><br><span class="line">        require(getPair[token0][token1] == address(0), &#x27;UniswapV2: PAIR_EXISTS&#x27;); // single check is sufficient</span><br><span class="line">        bytes memory bytecode = type(UniswapV2Pair).creationCode;</span><br><span class="line">        bytes32 salt = keccak256(abi.encodePacked(token0, token1));</span><br><span class="line">        assembly &#123;</span><br><span class="line">            pair := create2(0, add(bytecode, 32), mload(bytecode), salt)</span><br><span class="line">        &#125;</span><br><span class="line">        IUniswapV2Pair(pair).initialize(token0, token1);</span><br><span class="line">        getPair[token0][token1] = pair;</span><br><span class="line">        getPair[token1][token0] = pair; // populate mapping in the reverse direction</span><br><span class="line">        allPairs.push(pair);</span><br><span class="line">        emit PairCreated(token0, token1, pair, allPairs.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setFeeTo(address _feeTo) external &#123;</span><br><span class="line">        require(msg.sender == feeToSetter, &#x27;UniswapV2: FORBIDDEN&#x27;);</span><br><span class="line">        feeTo = _feeTo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setFeeToSetter(address _feeToSetter) external &#123;</span><br><span class="line">        require(msg.sender == feeToSetter, &#x27;UniswapV2: FORBIDDEN&#x27;);</span><br><span class="line">        feeToSetter = _feeToSetter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Anaylse"><a href="#Anaylse" class="headerlink" title="Anaylse"></a>Anaylse</h3><p><strong>Factoryå°±æ˜¯ä¸€ä¸ªè£…æœ‰è®¸å¤špairå¯¹çš„åˆçº¦ï¼Œå®ƒç”¨æ¥åˆ›å»ºæ–°çš„pairå¹¶ä¸”å‚¨å­˜æ‰€æœ‰çš„pairå¯¹ï¼Œå¯ä»¥é€šè¿‡ä¸¤ä¸ªtokençš„åœ°å€æ¥å¯»æ‰¾åˆ°ç›¸åº”çš„pairå¯¹</strong></p>
<h3 id="creatPair"><a href="#creatPair" class="headerlink" title="creatPair()"></a>creatPair()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function createPair(address tokenA, address tokenB) external returns (address pair) &#123;</span><br><span class="line">    require(tokenA != tokenB, &#x27;UniswapV2: IDENTICAL_ADDRESSES&#x27;);</span><br><span class="line">    (address token0, address token1) = tokenA &lt; tokenB ? (tokenA, tokenB) : (tokenB, tokenA);</span><br><span class="line">    require(token0 != address(0), &#x27;UniswapV2: ZERO_ADDRESS&#x27;);</span><br><span class="line">    require(getPair[token0][token1] == address(0), &#x27;UniswapV2: PAIR_EXISTS&#x27;); // single check is sufficient</span><br><span class="line">    bytes memory bytecode = type(UniswapV2Pair).creationCode;</span><br><span class="line">    bytes32 salt = keccak256(abi.encodePacked(token0, token1));</span><br><span class="line">    assembly &#123;</span><br><span class="line">        pair := create2(0, add(bytecode, 32), mload(bytecode), salt)</span><br><span class="line">    &#125;</span><br><span class="line">    IUniswapV2Pair(pair).initialize(token0, token1);</span><br><span class="line">    getPair[token0][token1] = pair;</span><br><span class="line">    getPair[token1][token0] = pair; // populate mapping in the reverse direction</span><br><span class="line">    allPairs.push(pair);</span><br><span class="line">    emit PairCreated(token0, token1, pair, allPairs.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç”¨æ¥creat2çš„æ–¹æ³•æ¥åˆ›å»ºpairå¯¹ï¼Œå¹¶ä¸”åˆå§‹åŒ–pairä¸­çš„token</strong></p>
<h3 id="library-UQ11"><a href="#library-UQ11" class="headerlink" title="library UQ11"></a>library UQ11</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">library UQ112x112 &#123;</span><br><span class="line">    uint224 constant Q112 = 2**112;</span><br><span class="line"></span><br><span class="line">    // encode a uint112 as a UQ112x112</span><br><span class="line">    function encode(uint112 y) internal pure returns (uint224 z) &#123;</span><br><span class="line">        z = uint224(y) * Q112; // never overflows</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // divide a UQ112x112 by a uint112, returning a UQ112x112</span><br><span class="line">    function uqdiv(uint224 x, uint112 y) internal pure returns (uint224 z) &#123;</span><br><span class="line">        z = x / uint224(y);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºsolidityä¸­ä¸å…è®¸å‡ºç°å°æ•°ï¼Œä½†æ˜¯tokenæ•°é‡åˆä¸€å®šä¼šå‡ºç°å°æ•°ï¼Œæ‰€ä»¥ä½¿ç”¨uint224ï¼Œå…¶ä¸­112ä½ä½œä¸ºæ•´æ•°éƒ¨åˆ†ï¼Œå¦112ä½ä½œä¸ºå°æ•°éƒ¨åˆ†ï¼Œè¿™æ ·ç²¾åº¦å³å¯è¾¾åˆ°1&#x2F;2**112,æœ€åçš„uint32ç”¨æ¥å­˜å‚¨timestamp</p>
<h1 id="UniswapV2Library"><a href="#UniswapV2Library" class="headerlink" title="UniswapV2Library"></a>UniswapV2Library</h1><h2 id="Code-3"><a href="#Code-3" class="headerlink" title="Code"></a>Code</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">library UniswapV2Library &#123;</span><br><span class="line">    using SafeMath for uint;</span><br><span class="line"></span><br><span class="line">    // returns sorted token addresses, used to handle return values from pairs sorted in this order</span><br><span class="line">    function sortTokens(address tokenA, address tokenB) internal pure returns (address token0, address token1) &#123;</span><br><span class="line">        require(tokenA != tokenB, &#x27;UniswapV2Library: IDENTICAL_ADDRESSES&#x27;);</span><br><span class="line">        (token0, token1) = tokenA &lt; tokenB ? (tokenA, tokenB) : (tokenB, tokenA);</span><br><span class="line">        require(token0 != address(0), &#x27;UniswapV2Library: ZERO_ADDRESS&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // calculates the CREATE2 address for a pair without making any external calls</span><br><span class="line">    function pairFor(address factory, address tokenA, address tokenB) internal pure returns (address pair) &#123;</span><br><span class="line">        (address token0, address token1) = sortTokens(tokenA, tokenB);</span><br><span class="line">        pair = address(uint(keccak256(abi.encodePacked(</span><br><span class="line">                hex&#x27;ff&#x27;,</span><br><span class="line">                factory,</span><br><span class="line">                keccak256(abi.encodePacked(token0, token1)),</span><br><span class="line">                hex&#x27;96e8ac4277198ff8b6f785478aa9a39f403cb768dd02cbee326c3e7da348845f&#x27; // init code hash</span><br><span class="line">            ))));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // fetches and sorts the reserves for a pair</span><br><span class="line">    function getReserves(address factory, address tokenA, address tokenB) internal view returns (uint reserveA, uint reserveB) &#123;</span><br><span class="line">        (address token0,) = sortTokens(tokenA, tokenB);</span><br><span class="line">        (uint reserve0, uint reserve1,) = IUniswapV2Pair(pairFor(factory, tokenA, tokenB)).getReserves();</span><br><span class="line">        (reserveA, reserveB) = tokenA == token0 ? (reserve0, reserve1) : (reserve1, reserve0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // given some amount of an asset and pair reserves, returns an equivalent amount of the other asset</span><br><span class="line">    function quote(uint amountA, uint reserveA, uint reserveB) internal pure returns (uint amountB) &#123;</span><br><span class="line">        require(amountA &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_AMOUNT&#x27;);</span><br><span class="line">        require(reserveA &gt; 0 &amp;&amp; reserveB &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line">        amountB = amountA.mul(reserveB) / reserveA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // given an input amount of an asset and pair reserves, returns the maximum output amount of the other asset</span><br><span class="line">    function getAmountOut(uint amountIn, uint reserveIn, uint reserveOut) internal pure returns (uint amountOut) &#123;</span><br><span class="line">        require(amountIn &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_INPUT_AMOUNT&#x27;);</span><br><span class="line">        require(reserveIn &gt; 0 &amp;&amp; reserveOut &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line">        uint amountInWithFee = amountIn.mul(997);</span><br><span class="line">        uint numerator = amountInWithFee.mul(reserveOut);</span><br><span class="line">        uint denominator = reserveIn.mul(1000).add(amountInWithFee);</span><br><span class="line">        amountOut = numerator / denominator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // given an output amount of an asset and pair reserves, returns a required input amount of the other asset</span><br><span class="line">    function getAmountIn(uint amountOut, uint reserveIn, uint reserveOut) internal pure returns (uint amountIn) &#123;</span><br><span class="line">        require(amountOut &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">        require(reserveIn &gt; 0 &amp;&amp; reserveOut &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line">        uint numerator = reserveIn.mul(amountOut).mul(1000);</span><br><span class="line">        uint denominator = reserveOut.sub(amountOut).mul(997);</span><br><span class="line">        amountIn = (numerator / denominator).add(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // performs chained getAmountOut calculations on any number of pairs</span><br><span class="line">    function getAmountsOut(address factory, uint amountIn, address[] memory path) internal view returns (uint[] memory amounts) &#123;</span><br><span class="line">        require(path.length &gt;= 2, &#x27;UniswapV2Library: INVALID_PATH&#x27;);</span><br><span class="line">        amounts = new uint[](path.length);</span><br><span class="line">        amounts[0] = amountIn;</span><br><span class="line">        for (uint i; i &lt; path.length - 1; i++) &#123;</span><br><span class="line">            (uint reserveIn, uint reserveOut) = getReserves(factory, path[i], path[i + 1]);</span><br><span class="line">            amounts[i + 1] = getAmountOut(amounts[i], reserveIn, reserveOut);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // performs chained getAmountIn calculations on any number of pairs</span><br><span class="line">    function getAmountsIn(address factory, uint amountOut, address[] memory path) internal view returns (uint[] memory amounts) &#123;</span><br><span class="line">        require(path.length &gt;= 2, &#x27;UniswapV2Library: INVALID_PATH&#x27;);</span><br><span class="line">        amounts = new uint[](path.length);</span><br><span class="line">        amounts[amounts.length - 1] = amountOut;</span><br><span class="line">        for (uint i = path.length - 1; i &gt; 0; i--) &#123;</span><br><span class="line">            (uint reserveIn, uint reserveOut) = getReserves(factory, path[i - 1], path[i]);</span><br><span class="line">            amounts[i - 1] = getAmountIn(amounts[i], reserveIn, reserveOut);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Analyse-2"><a href="#Analyse-2" class="headerlink" title="Analyse"></a>Analyse</h2><p>å°±æ˜¯ä¸€ä¸ªåº“å‡½æ•°è€Œå·²ï¼Œé‡Œé¢æœ‰ä¸€äº›æœ‰ç”¨çš„å‡½æ•°</p>
<h2 id="sortTokens-address-tokenA-address-tokenB"><a href="#sortTokens-address-tokenA-address-tokenB" class="headerlink" title="sortTokens(address tokenA,address tokenB)"></a>sortTokens(address tokenA,address tokenB)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function sortTokens(address tokenA, address tokenB) internal pure returns (address token0, address token1) &#123;</span><br><span class="line">    require(tokenA != tokenB, &#x27;UniswapV2Library: IDENTICAL_ADDRESSES&#x27;);</span><br><span class="line">    (token0, token1) = tokenA &lt; tokenB ? (tokenA, tokenB) : (tokenB, tokenA);</span><br><span class="line">    require(token0 != address(0), &#x27;UniswapV2Library: ZERO_ADDRESS&#x27;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†tokenA,Bä»å°åˆ°å¤§æ’åºï¼Œè¦æ±‚tokenA!&#x3D;tokenB,ä¸”ä¸èƒ½æ˜¯address(0)</p>
<h2 id="pairFor-address-factory-address-tokenA-address-tokenB"><a href="#pairFor-address-factory-address-tokenA-address-tokenB" class="headerlink" title="pairFor(address factory, address tokenA, address tokenB)"></a>pairFor(address factory, address tokenA, address tokenB)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function pairFor(address factory, address tokenA, address tokenB) internal pure returns (address pair) &#123;</span><br><span class="line">    (address token0, address token1) = sortTokens(tokenA, tokenB);</span><br><span class="line">    pair = address(uint(keccak256(abi.encodePacked(</span><br><span class="line">            hex&#x27;ff&#x27;,</span><br><span class="line">            factory,</span><br><span class="line">            keccak256(abi.encodePacked(token0, token1)),</span><br><span class="line">            hex&#x27;96e8ac4277198ff8b6f785478aa9a39f403cb768dd02cbee326c3e7da348845f&#x27; // init code hash</span><br><span class="line">        ))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯»æ‰¾åˆ°factoryåˆçº¦ä¸­å¯¹åº”tokenA,Bçš„pairåˆçº¦åœ°å€</p>
<h2 id="getReserves-address-factory-address-tokenA-address-tokenB"><a href="#getReserves-address-factory-address-tokenA-address-tokenB" class="headerlink" title="getReserves(address factory, address tokenA, address tokenB)"></a>getReserves(address factory, address tokenA, address tokenB)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function getReserves(address factory, address tokenA, address tokenB) internal view returns (uint reserveA, uint reserveB) &#123;</span><br><span class="line">    (address token0,) = sortTokens(tokenA, tokenB);</span><br><span class="line">    (uint reserve0, uint reserve1,) = IUniswapV2Pair(pairFor(factory, tokenA, tokenB)).getReserves();</span><br><span class="line">    (reserveA, reserveB) = tokenA == token0 ? (reserve0, reserve1) : (reserve1, reserve0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨äºå¾—åˆ°å¯¹åº”pairåˆçº¦ä¸­çš„tokenA,Bçš„å‚¨è“„é‡‘</p>
<h2 id="quote-uint-amountA-uint-reserveA-uint-reserveB"><a href="#quote-uint-amountA-uint-reserveA-uint-reserveB" class="headerlink" title="quote(uint amountA, uint reserveA, uint reserveB)"></a>quote(uint amountA, uint reserveA, uint reserveB)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function quote(uint amountA, uint reserveA, uint reserveB) internal pure returns (uint amountB) &#123;</span><br><span class="line">    require(amountA &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_AMOUNT&#x27;);</span><br><span class="line">    require(reserveA &gt; 0 &amp;&amp; reserveB &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line">    amountB = amountA.mul(reserveB) / reserveA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨äºè®¡ç®—å‡ºä¸å‚¨è“„é‡‘ç­‰æ¯”ä¾‹çš„amountB</p>
<h2 id="getAmountOut-uint-amountIn-uint-reserveIn-uint-reserveOut"><a href="#getAmountOut-uint-amountIn-uint-reserveIn-uint-reserveOut" class="headerlink" title="getAmountOut(uint amountIn, uint reserveIn, uint reserveOut)"></a>getAmountOut(uint amountIn, uint reserveIn, uint reserveOut)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function getAmountOut(uint amountIn, uint reserveIn, uint reserveOut) internal pure returns (uint amountOut) &#123;</span><br><span class="line">        require(amountIn &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_INPUT_AMOUNT&#x27;);</span><br><span class="line">        require(reserveIn &gt; 0 &amp;&amp; reserveOut &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line">        uint amountInWithFee = amountIn.mul(997);</span><br><span class="line">        uint numerator = amountInWithFee.mul(reserveOut);</span><br><span class="line">        uint denominator = reserveIn.mul(1000).add(amountInWithFee);</span><br><span class="line">        amountOut = numerator / denominator;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨æ¥å¾—åˆ°amountInæ•°é‡çš„tokenå¯ä»¥æ¢å–å¦ä¸€ç§tokençš„æ•°é‡</p>
<h2 id="getAmountIn-uint-amountOut-uint-reserveIn-uint-reserveOut"><a href="#getAmountIn-uint-amountOut-uint-reserveIn-uint-reserveOut" class="headerlink" title="getAmountIn(uint amountOut, uint reserveIn, uint reserveOut)"></a>getAmountIn(uint amountOut, uint reserveIn, uint reserveOut)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function getAmountIn(uint amountOut, uint reserveIn, uint reserveOut) internal pure returns (uint amountIn) &#123;</span><br><span class="line">    require(amountOut &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">    require(reserveIn &gt; 0 &amp;&amp; reserveOut &gt; 0, &#x27;UniswapV2Library: INSUFFICIENT_LIQUIDITY&#x27;);</span><br><span class="line">    uint numerator = reserveIn.mul(amountOut).mul(1000);</span><br><span class="line">    uint denominator = reserveOut.sub(amountOut).mul(997);</span><br><span class="line">    amountIn = (numerator / denominator).add(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨æ¥è®¡ç®—amountOutæ•°é‡çš„tokenéœ€è¦å¤šå°‘amountInçš„tokenæ•°é‡</p>
<h2 id="getAmountsOut-address-factory-uint-amountIn-address-memory-path"><a href="#getAmountsOut-address-factory-uint-amountIn-address-memory-path" class="headerlink" title="getAmountsOut(address factory, uint amountIn, address[] memory path)"></a>getAmountsOut(address factory, uint amountIn, address[] memory path)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function getAmountsOut(address factory, uint amountIn, address[] memory path) internal view returns (uint[] memory amounts) &#123;</span><br><span class="line">    require(path.length &gt;= 2, &#x27;UniswapV2Library: INVALID_PATH&#x27;);</span><br><span class="line">    amounts = new uint[](path.length);</span><br><span class="line">    amounts[0] = amountIn;</span><br><span class="line">    for (uint i; i &lt; path.length - 1; i++) &#123;</span><br><span class="line">        (uint reserveIn, uint reserveOut) = getReserves(factory, path[i], path[i + 1]);</span><br><span class="line">        amounts[i + 1] = getAmountOut(amounts[i], reserveIn, reserveOut);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨äºtoken0-&gt;token1-&gt;token2-&gt;token3-&gt;â€¦â€¦.ç­‰è¿ç»­äº¤æ¢ï¼Œç”¨amountInæ•°é‡çš„tokenæ¥è¿ç»­äº¤æ¢ï¼Œå¹¶å°†æ¯æ¬¡èƒ½æ¢å‡ºçš„æ•°é‡è¿›è¡Œå‚¨å­˜ï¼Œè¿›è¡Œnæ¬¡äº¤æ¢ï¼Œå¹¶è¿”å›æŒ‰è·¯å¾„äº¤æ¢çš„å„æ¬¡æ•°é‡çš„æ•°ç»„</p>
<h1 id="UniswapV2Router02"><a href="#UniswapV2Router02" class="headerlink" title="UniswapV2Router02"></a>UniswapV2Router02</h1><h2 id="Code-4"><a href="#Code-4" class="headerlink" title="Code"></a>Code</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br></pre></td><td class="code"><pre><span class="line">contract UniswapV2Router02 is IUniswapV2Router02 &#123;</span><br><span class="line">    using SafeMath for uint;</span><br><span class="line"></span><br><span class="line">    address public immutable override factory;</span><br><span class="line">    address public immutable override WETH;</span><br><span class="line"></span><br><span class="line">    modifier ensure(uint deadline) &#123;</span><br><span class="line">        require(deadline &gt;= block.timestamp, &#x27;UniswapV2Router: EXPIRED&#x27;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor(address _factory, address _WETH) public &#123;</span><br><span class="line">        factory = _factory;</span><br><span class="line">        WETH = _WETH;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        assert(msg.sender == WETH); // only accept ETH via fallback from the WETH contract</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // **** ADD LIQUIDITY ****</span><br><span class="line">    function _addLiquidity(</span><br><span class="line">        address tokenA,</span><br><span class="line">        address tokenB,</span><br><span class="line">        uint amountADesired,</span><br><span class="line">        uint amountBDesired,</span><br><span class="line">        uint amountAMin,</span><br><span class="line">        uint amountBMin</span><br><span class="line">    ) internal virtual returns (uint amountA, uint amountB) &#123;</span><br><span class="line">        // create the pair if it doesn&#x27;t exist yet</span><br><span class="line">        if (IUniswapV2Factory(factory).getPair(tokenA, tokenB) == address(0)) &#123;</span><br><span class="line">            IUniswapV2Factory(factory).createPair(tokenA, tokenB);</span><br><span class="line">        &#125;</span><br><span class="line">        (uint reserveA, uint reserveB) = UniswapV2Library.getReserves(factory, tokenA, tokenB);</span><br><span class="line">        if (reserveA == 0 &amp;&amp; reserveB == 0) &#123;</span><br><span class="line">            (amountA, amountB) = (amountADesired, amountBDesired);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            uint amountBOptimal = UniswapV2Library.quote(amountADesired, reserveA, reserveB);</span><br><span class="line">            if (amountBOptimal &lt;= amountBDesired) &#123;</span><br><span class="line">                require(amountBOptimal &gt;= amountBMin, &#x27;UniswapV2Router: INSUFFICIENT_B_AMOUNT&#x27;);</span><br><span class="line">                (amountA, amountB) = (amountADesired, amountBOptimal);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                uint amountAOptimal = UniswapV2Library.quote(amountBDesired, reserveB, reserveA);</span><br><span class="line">                assert(amountAOptimal &lt;= amountADesired);</span><br><span class="line">                require(amountAOptimal &gt;= amountAMin, &#x27;UniswapV2Router: INSUFFICIENT_A_AMOUNT&#x27;);</span><br><span class="line">                (amountA, amountB) = (amountAOptimal, amountBDesired);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    function addLiquidity(</span><br><span class="line">        address tokenA,</span><br><span class="line">        address tokenB,</span><br><span class="line">        uint amountADesired,</span><br><span class="line">        uint amountBDesired,</span><br><span class="line">        uint amountAMin,</span><br><span class="line">        uint amountBMin,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    ) external virtual override ensure(deadline) returns (uint amountA, uint amountB, uint liquidity) &#123;</span><br><span class="line">        (amountA, amountB) = _addLiquidity(tokenA, tokenB, amountADesired, amountBDesired, amountAMin, amountBMin);</span><br><span class="line">        address pair = UniswapV2Library.pairFor(factory, tokenA, tokenB);</span><br><span class="line">        TransferHelper.safeTransferFrom(tokenA, msg.sender, pair, amountA);</span><br><span class="line">        TransferHelper.safeTransferFrom(tokenB, msg.sender, pair, amountB);</span><br><span class="line">        liquidity = IUniswapV2Pair(pair).mint(to);</span><br><span class="line">    &#125;</span><br><span class="line">    function addLiquidityETH(</span><br><span class="line">        address token,</span><br><span class="line">        uint amountTokenDesired,</span><br><span class="line">        uint amountTokenMin,</span><br><span class="line">        uint amountETHMin,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    ) external virtual override payable ensure(deadline) returns (uint amountToken, uint amountETH, uint liquidity) &#123;</span><br><span class="line">        (amountToken, amountETH) = _addLiquidity(</span><br><span class="line">            token,</span><br><span class="line">            WETH,</span><br><span class="line">            amountTokenDesired,</span><br><span class="line">            msg.value,</span><br><span class="line">            amountTokenMin,</span><br><span class="line">            amountETHMin</span><br><span class="line">        );</span><br><span class="line">        address pair = UniswapV2Library.pairFor(factory, token, WETH);</span><br><span class="line">        TransferHelper.safeTransferFrom(token, msg.sender, pair, amountToken);</span><br><span class="line">        IWETH(WETH).deposit&#123;value: amountETH&#125;();</span><br><span class="line">        assert(IWETH(WETH).transfer(pair, amountETH));</span><br><span class="line">        liquidity = IUniswapV2Pair(pair).mint(to);</span><br><span class="line">        // refund dust eth, if any</span><br><span class="line">        if (msg.value &gt; amountETH) TransferHelper.safeTransferETH(msg.sender, msg.value - amountETH);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // **** REMOVE LIQUIDITY ****</span><br><span class="line">    function removeLiquidity(</span><br><span class="line">        address tokenA,</span><br><span class="line">        address tokenB,</span><br><span class="line">        uint liquidity,</span><br><span class="line">        uint amountAMin,</span><br><span class="line">        uint amountBMin,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    ) public virtual override ensure(deadline) returns (uint amountA, uint amountB) &#123;</span><br><span class="line">        address pair = UniswapV2Library.pairFor(factory, tokenA, tokenB);</span><br><span class="line">        IUniswapV2Pair(pair).transferFrom(msg.sender, pair, liquidity); // send liquidity to pair</span><br><span class="line">        (uint amount0, uint amount1) = IUniswapV2Pair(pair).burn(to);</span><br><span class="line">        (address token0,) = UniswapV2Library.sortTokens(tokenA, tokenB);</span><br><span class="line">        (amountA, amountB) = tokenA == token0 ? (amount0, amount1) : (amount1, amount0);</span><br><span class="line">        require(amountA &gt;= amountAMin, &#x27;UniswapV2Router: INSUFFICIENT_A_AMOUNT&#x27;);</span><br><span class="line">        require(amountB &gt;= amountBMin, &#x27;UniswapV2Router: INSUFFICIENT_B_AMOUNT&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">    function removeLiquidityETH(</span><br><span class="line">        address token,</span><br><span class="line">        uint liquidity,</span><br><span class="line">        uint amountTokenMin,</span><br><span class="line">        uint amountETHMin,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    ) public virtual override ensure(deadline) returns (uint amountToken, uint amountETH) &#123;</span><br><span class="line">        (amountToken, amountETH) = removeLiquidity(</span><br><span class="line">            token,</span><br><span class="line">            WETH,</span><br><span class="line">            liquidity,</span><br><span class="line">            amountTokenMin,</span><br><span class="line">            amountETHMin,</span><br><span class="line">            address(this),</span><br><span class="line">            deadline</span><br><span class="line">        );</span><br><span class="line">        TransferHelper.safeTransfer(token, to, amountToken);</span><br><span class="line">        IWETH(WETH).withdraw(amountETH);</span><br><span class="line">        TransferHelper.safeTransferETH(to, amountETH);</span><br><span class="line">    &#125;</span><br><span class="line">    function removeLiquidityWithPermit(</span><br><span class="line">        address tokenA,</span><br><span class="line">        address tokenB,</span><br><span class="line">        uint liquidity,</span><br><span class="line">        uint amountAMin,</span><br><span class="line">        uint amountBMin,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline,</span><br><span class="line">        bool approveMax, uint8 v, bytes32 r, bytes32 s</span><br><span class="line">    ) external virtual override returns (uint amountA, uint amountB) &#123;</span><br><span class="line">        address pair = UniswapV2Library.pairFor(factory, tokenA, tokenB);</span><br><span class="line">        uint value = approveMax ? uint(-1) : liquidity;</span><br><span class="line">        IUniswapV2Pair(pair).permit(msg.sender, address(this), value, deadline, v, r, s);</span><br><span class="line">        (amountA, amountB) = removeLiquidity(tokenA, tokenB, liquidity, amountAMin, amountBMin, to, deadline);</span><br><span class="line">    &#125;</span><br><span class="line">    function removeLiquidityETHWithPermit(</span><br><span class="line">        address token,</span><br><span class="line">        uint liquidity,</span><br><span class="line">        uint amountTokenMin,</span><br><span class="line">        uint amountETHMin,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline,</span><br><span class="line">        bool approveMax, uint8 v, bytes32 r, bytes32 s</span><br><span class="line">    ) external virtual override returns (uint amountToken, uint amountETH) &#123;</span><br><span class="line">        address pair = UniswapV2Library.pairFor(factory, token, WETH);</span><br><span class="line">        uint value = approveMax ? uint(-1) : liquidity;</span><br><span class="line">        IUniswapV2Pair(pair).permit(msg.sender, address(this), value, deadline, v, r, s);</span><br><span class="line">        (amountToken, amountETH) = removeLiquidityETH(token, liquidity, amountTokenMin, amountETHMin, to, deadline);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // **** REMOVE LIQUIDITY (supporting fee-on-transfer tokens) ****</span><br><span class="line">    function removeLiquidityETHSupportingFeeOnTransferTokens(</span><br><span class="line">        address token,</span><br><span class="line">        uint liquidity,</span><br><span class="line">        uint amountTokenMin,</span><br><span class="line">        uint amountETHMin,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    ) public virtual override ensure(deadline) returns (uint amountETH) &#123;</span><br><span class="line">        (, amountETH) = removeLiquidity(</span><br><span class="line">            token,</span><br><span class="line">            WETH,</span><br><span class="line">            liquidity,</span><br><span class="line">            amountTokenMin,</span><br><span class="line">            amountETHMin,</span><br><span class="line">            address(this),</span><br><span class="line">            deadline</span><br><span class="line">        );</span><br><span class="line">        TransferHelper.safeTransfer(token, to, IERC20(token).balanceOf(address(this)));</span><br><span class="line">        IWETH(WETH).withdraw(amountETH);</span><br><span class="line">        TransferHelper.safeTransferETH(to, amountETH);</span><br><span class="line">    &#125;</span><br><span class="line">    function removeLiquidityETHWithPermitSupportingFeeOnTransferTokens(</span><br><span class="line">        address token,</span><br><span class="line">        uint liquidity,</span><br><span class="line">        uint amountTokenMin,</span><br><span class="line">        uint amountETHMin,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline,</span><br><span class="line">        bool approveMax, uint8 v, bytes32 r, bytes32 s</span><br><span class="line">    ) external virtual override returns (uint amountETH) &#123;</span><br><span class="line">        address pair = UniswapV2Library.pairFor(factory, token, WETH);</span><br><span class="line">        uint value = approveMax ? uint(-1) : liquidity;</span><br><span class="line">        IUniswapV2Pair(pair).permit(msg.sender, address(this), value, deadline, v, r, s);</span><br><span class="line">        amountETH = removeLiquidityETHSupportingFeeOnTransferTokens(</span><br><span class="line">            token, liquidity, amountTokenMin, amountETHMin, to, deadline</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // **** SWAP ****</span><br><span class="line">    // requires the initial amount to have already been sent to the first pair</span><br><span class="line">    function _swap(uint[] memory amounts, address[] memory path, address _to) internal virtual &#123;</span><br><span class="line">        for (uint i; i &lt; path.length - 1; i++) &#123;</span><br><span class="line">            (address input, address output) = (path[i], path[i + 1]);</span><br><span class="line">            (address token0,) = UniswapV2Library.sortTokens(input, output);</span><br><span class="line">            uint amountOut = amounts[i + 1];</span><br><span class="line">            (uint amount0Out, uint amount1Out) = input == token0 ? (uint(0), amountOut) : (amountOut, uint(0));</span><br><span class="line">            address to = i &lt; path.length - 2 ? UniswapV2Library.pairFor(factory, output, path[i + 2]) : _to;</span><br><span class="line">            IUniswapV2Pair(UniswapV2Library.pairFor(factory, input, output)).swap(</span><br><span class="line">                amount0Out, amount1Out, to, new bytes(0)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    function swapExactTokensForTokens(</span><br><span class="line">        uint amountIn,</span><br><span class="line">        uint amountOutMin,</span><br><span class="line">        address[] calldata path,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    ) external virtual override ensure(deadline) returns (uint[] memory amounts) &#123;</span><br><span class="line">        amounts = UniswapV2Library.getAmountsOut(factory, amountIn, path);</span><br><span class="line">        require(amounts[amounts.length - 1] &gt;= amountOutMin, &#x27;UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">        TransferHelper.safeTransferFrom(</span><br><span class="line">            path[0], msg.sender, UniswapV2Library.pairFor(factory, path[0], path[1]), amounts[0]</span><br><span class="line">        );</span><br><span class="line">        _swap(amounts, path, to);</span><br><span class="line">    &#125;</span><br><span class="line">    function swapTokensForExactTokens(</span><br><span class="line">        uint amountOut,</span><br><span class="line">        uint amountInMax,</span><br><span class="line">        address[] calldata path,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    ) external virtual override ensure(deadline) returns (uint[] memory amounts) &#123;</span><br><span class="line">        amounts = UniswapV2Library.getAmountsIn(factory, amountOut, path);</span><br><span class="line">        require(amounts[0] &lt;= amountInMax, &#x27;UniswapV2Router: EXCESSIVE_INPUT_AMOUNT&#x27;);</span><br><span class="line">        TransferHelper.safeTransferFrom(</span><br><span class="line">            path[0], msg.sender, UniswapV2Library.pairFor(factory, path[0], path[1]), amounts[0]</span><br><span class="line">        );</span><br><span class="line">        _swap(amounts, path, to);</span><br><span class="line">    &#125;</span><br><span class="line">    function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline)</span><br><span class="line">        external</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        payable</span><br><span class="line">        ensure(deadline)</span><br><span class="line">        returns (uint[] memory amounts)</span><br><span class="line">    &#123;</span><br><span class="line">        require(path[0] == WETH, &#x27;UniswapV2Router: INVALID_PATH&#x27;);</span><br><span class="line">        amounts = UniswapV2Library.getAmountsOut(factory, msg.value, path);</span><br><span class="line">        require(amounts[amounts.length - 1] &gt;= amountOutMin, &#x27;UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">        IWETH(WETH).deposit&#123;value: amounts[0]&#125;();</span><br><span class="line">        assert(IWETH(WETH).transfer(UniswapV2Library.pairFor(factory, path[0], path[1]), amounts[0]));</span><br><span class="line">        _swap(amounts, path, to);</span><br><span class="line">    &#125;</span><br><span class="line">    function swapTokensForExactETH(uint amountOut, uint amountInMax, address[] calldata path, address to, uint deadline)</span><br><span class="line">        external</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        ensure(deadline)</span><br><span class="line">        returns (uint[] memory amounts)</span><br><span class="line">    &#123;</span><br><span class="line">        require(path[path.length - 1] == WETH, &#x27;UniswapV2Router: INVALID_PATH&#x27;);</span><br><span class="line">        amounts = UniswapV2Library.getAmountsIn(factory, amountOut, path);</span><br><span class="line">        require(amounts[0] &lt;= amountInMax, &#x27;UniswapV2Router: EXCESSIVE_INPUT_AMOUNT&#x27;);</span><br><span class="line">        TransferHelper.safeTransferFrom(</span><br><span class="line">            path[0], msg.sender, UniswapV2Library.pairFor(factory, path[0], path[1]), amounts[0]</span><br><span class="line">        );</span><br><span class="line">        _swap(amounts, path, address(this));</span><br><span class="line">        IWETH(WETH).withdraw(amounts[amounts.length - 1]);</span><br><span class="line">        TransferHelper.safeTransferETH(to, amounts[amounts.length - 1]);</span><br><span class="line">    &#125;</span><br><span class="line">    function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline)</span><br><span class="line">        external</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        ensure(deadline)</span><br><span class="line">        returns (uint[] memory amounts)</span><br><span class="line">    &#123;</span><br><span class="line">        require(path[path.length - 1] == WETH, &#x27;UniswapV2Router: INVALID_PATH&#x27;);</span><br><span class="line">        amounts = UniswapV2Library.getAmountsOut(factory, amountIn, path);</span><br><span class="line">        require(amounts[amounts.length - 1] &gt;= amountOutMin, &#x27;UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">        TransferHelper.safeTransferFrom(</span><br><span class="line">            path[0], msg.sender, UniswapV2Library.pairFor(factory, path[0], path[1]), amounts[0]</span><br><span class="line">        );</span><br><span class="line">        _swap(amounts, path, address(this));</span><br><span class="line">        IWETH(WETH).withdraw(amounts[amounts.length - 1]);</span><br><span class="line">        TransferHelper.safeTransferETH(to, amounts[amounts.length - 1]);</span><br><span class="line">    &#125;</span><br><span class="line">    function swapETHForExactTokens(uint amountOut, address[] calldata path, address to, uint deadline)</span><br><span class="line">        external</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        payable</span><br><span class="line">        ensure(deadline)</span><br><span class="line">        returns (uint[] memory amounts)</span><br><span class="line">    &#123;</span><br><span class="line">        require(path[0] == WETH, &#x27;UniswapV2Router: INVALID_PATH&#x27;);</span><br><span class="line">        amounts = UniswapV2Library.getAmountsIn(factory, amountOut, path);</span><br><span class="line">        require(amounts[0] &lt;= msg.value, &#x27;UniswapV2Router: EXCESSIVE_INPUT_AMOUNT&#x27;);</span><br><span class="line">        IWETH(WETH).deposit&#123;value: amounts[0]&#125;();</span><br><span class="line">        assert(IWETH(WETH).transfer(UniswapV2Library.pairFor(factory, path[0], path[1]), amounts[0]));</span><br><span class="line">        _swap(amounts, path, to);</span><br><span class="line">        // refund dust eth, if any</span><br><span class="line">        if (msg.value &gt; amounts[0]) TransferHelper.safeTransferETH(msg.sender, msg.value - amounts[0]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // **** SWAP (supporting fee-on-transfer tokens) ****</span><br><span class="line">    // requires the initial amount to have already been sent to the first pair</span><br><span class="line">    function _swapSupportingFeeOnTransferTokens(address[] memory path, address _to) internal virtual &#123;</span><br><span class="line">        for (uint i; i &lt; path.length - 1; i++) &#123;</span><br><span class="line">            (address input, address output) = (path[i], path[i + 1]);</span><br><span class="line">            (address token0,) = UniswapV2Library.sortTokens(input, output);</span><br><span class="line">            IUniswapV2Pair pair = IUniswapV2Pair(UniswapV2Library.pairFor(factory, input, output));</span><br><span class="line">            uint amountInput;</span><br><span class="line">            uint amountOutput;</span><br><span class="line">            &#123; // scope to avoid stack too deep errors</span><br><span class="line">            (uint reserve0, uint reserve1,) = pair.getReserves();</span><br><span class="line">            (uint reserveInput, uint reserveOutput) = input == token0 ? (reserve0, reserve1) : (reserve1, reserve0);</span><br><span class="line">            amountInput = IERC20(input).balanceOf(address(pair)).sub(reserveInput);</span><br><span class="line">            amountOutput = UniswapV2Library.getAmountOut(amountInput, reserveInput, reserveOutput);</span><br><span class="line">            &#125;</span><br><span class="line">            (uint amount0Out, uint amount1Out) = input == token0 ? (uint(0), amountOutput) : (amountOutput, uint(0));</span><br><span class="line">            address to = i &lt; path.length - 2 ? UniswapV2Library.pairFor(factory, output, path[i + 2]) : _to;</span><br><span class="line">            pair.swap(amount0Out, amount1Out, to, new bytes(0));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    function swapExactTokensForTokensSupportingFeeOnTransferTokens(</span><br><span class="line">        uint amountIn,</span><br><span class="line">        uint amountOutMin,</span><br><span class="line">        address[] calldata path,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    ) external virtual override ensure(deadline) &#123;</span><br><span class="line">        TransferHelper.safeTransferFrom(</span><br><span class="line">            path[0], msg.sender, UniswapV2Library.pairFor(factory, path[0], path[1]), amountIn</span><br><span class="line">        );</span><br><span class="line">        uint balanceBefore = IERC20(path[path.length - 1]).balanceOf(to);</span><br><span class="line">        _swapSupportingFeeOnTransferTokens(path, to);</span><br><span class="line">        require(</span><br><span class="line">            IERC20(path[path.length - 1]).balanceOf(to).sub(balanceBefore) &gt;= amountOutMin,</span><br><span class="line">            &#x27;UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT&#x27;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    function swapExactETHForTokensSupportingFeeOnTransferTokens(</span><br><span class="line">        uint amountOutMin,</span><br><span class="line">        address[] calldata path,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    )</span><br><span class="line">        external</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        payable</span><br><span class="line">        ensure(deadline)</span><br><span class="line">    &#123;</span><br><span class="line">        require(path[0] == WETH, &#x27;UniswapV2Router: INVALID_PATH&#x27;);</span><br><span class="line">        uint amountIn = msg.value;</span><br><span class="line">        IWETH(WETH).deposit&#123;value: amountIn&#125;();</span><br><span class="line">        assert(IWETH(WETH).transfer(UniswapV2Library.pairFor(factory, path[0], path[1]), amountIn));</span><br><span class="line">        uint balanceBefore = IERC20(path[path.length - 1]).balanceOf(to);</span><br><span class="line">        _swapSupportingFeeOnTransferTokens(path, to);</span><br><span class="line">        require(</span><br><span class="line">            IERC20(path[path.length - 1]).balanceOf(to).sub(balanceBefore) &gt;= amountOutMin,</span><br><span class="line">            &#x27;UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT&#x27;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    function swapExactTokensForETHSupportingFeeOnTransferTokens(</span><br><span class="line">        uint amountIn,</span><br><span class="line">        uint amountOutMin,</span><br><span class="line">        address[] calldata path,</span><br><span class="line">        address to,</span><br><span class="line">        uint deadline</span><br><span class="line">    )</span><br><span class="line">        external</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        ensure(deadline)</span><br><span class="line">    &#123;</span><br><span class="line">        require(path[path.length - 1] == WETH, &#x27;UniswapV2Router: INVALID_PATH&#x27;);</span><br><span class="line">        TransferHelper.safeTransferFrom(</span><br><span class="line">            path[0], msg.sender, UniswapV2Library.pairFor(factory, path[0], path[1]), amountIn</span><br><span class="line">        );</span><br><span class="line">        _swapSupportingFeeOnTransferTokens(path, address(this));</span><br><span class="line">        uint amountOut = IERC20(WETH).balanceOf(address(this));</span><br><span class="line">        require(amountOut &gt;= amountOutMin, &#x27;UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT&#x27;);</span><br><span class="line">        IWETH(WETH).withdraw(amountOut);</span><br><span class="line">        TransferHelper.safeTransferETH(to, amountOut);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // **** LIBRARY FUNCTIONS ****</span><br><span class="line">    function quote(uint amountA, uint reserveA, uint reserveB) public pure virtual override returns (uint amountB) &#123;</span><br><span class="line">        return UniswapV2Library.quote(amountA, reserveA, reserveB);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAmountOut(uint amountIn, uint reserveIn, uint reserveOut)</span><br><span class="line">        public</span><br><span class="line">        pure</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        returns (uint amountOut)</span><br><span class="line">    &#123;</span><br><span class="line">        return UniswapV2Library.getAmountOut(amountIn, reserveIn, reserveOut);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAmountIn(uint amountOut, uint reserveIn, uint reserveOut)</span><br><span class="line">        public</span><br><span class="line">        pure</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        returns (uint amountIn)</span><br><span class="line">    &#123;</span><br><span class="line">        return UniswapV2Library.getAmountIn(amountOut, reserveIn, reserveOut);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAmountsOut(uint amountIn, address[] memory path)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        returns (uint[] memory amounts)</span><br><span class="line">    &#123;</span><br><span class="line">        return UniswapV2Library.getAmountsOut(factory, amountIn, path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getAmountsIn(uint amountOut, address[] memory path)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        virtual</span><br><span class="line">        override</span><br><span class="line">        returns (uint[] memory amounts)</span><br><span class="line">    &#123;</span><br><span class="line">        return UniswapV2Library.getAmountsIn(factory, amountOut, path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Analyse-3"><a href="#Analyse-3" class="headerlink" title="Analyse"></a>Analyse</h2><h2 id="addLiquidity-â€¦â€¦â€¦"><a href="#addLiquidity-â€¦â€¦â€¦" class="headerlink" title="_addLiquidity(â€¦â€¦â€¦.)"></a>_addLiquidity(â€¦â€¦â€¦.)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">function _addLiquidity(</span><br><span class="line">    address tokenA,</span><br><span class="line">    address tokenB,</span><br><span class="line">    uint amountADesired,</span><br><span class="line">    uint amountBDesired,</span><br><span class="line">    uint amountAMin,</span><br><span class="line">    uint amountBMin</span><br><span class="line">) internal virtual returns (uint amountA, uint amountB) &#123;</span><br><span class="line">    // create the pair if it doesn&#x27;t exist yet</span><br><span class="line">    if (IUniswapV2Factory(factory).getPair(tokenA, tokenB) == address(0)) &#123;</span><br><span class="line">        IUniswapV2Factory(factory).createPair(tokenA, tokenB);</span><br><span class="line">    &#125;</span><br><span class="line">    (uint reserveA, uint reserveB) = UniswapV2Library.getReserves(factory, tokenA, tokenB);</span><br><span class="line">    if (reserveA == 0 &amp;&amp; reserveB == 0) &#123;</span><br><span class="line">        (amountA, amountB) = (amountADesired, amountBDesired);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        uint amountBOptimal = UniswapV2Library.quote(amountADesired, reserveA, reserveB);</span><br><span class="line">        if (amountBOptimal &lt;= amountBDesired) &#123;</span><br><span class="line">            require(amountBOptimal &gt;= amountBMin, &#x27;UniswapV2Router: INSUFFICIENT_B_AMOUNT&#x27;);</span><br><span class="line">            (amountA, amountB) = (amountADesired, amountBOptimal);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            uint amountAOptimal = UniswapV2Library.quote(amountBDesired, reserveB, reserveA);</span><br><span class="line">            assert(amountAOptimal &lt;= amountADesired);</span><br><span class="line">            require(amountAOptimal &gt;= amountAMin, &#x27;UniswapV2Router: INSUFFICIENT_A_AMOUNT&#x27;);</span><br><span class="line">            (amountA, amountB) = (amountAOptimal, amountBDesired);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ƒçš„åŠŸèƒ½å°±æ˜¯ç”¨æ¥å¯»æ‰¾æœ€ä½³çš„tokenA,Bæ•°é‡</p>
<p>å†…éƒ¨å‡½æ•°ï¼Œé¦–å…ˆä¼šå¯»æ‰¾tokenA,Bæ˜¯å¦æœ‰pairå¯¹ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºpair,ç„¶åpairçš„è·å–å‚¨å­˜é‡‘ï¼Œå¦‚æœå‚¨è“„é‡‘éƒ½ä¸º0é‚£ä¹ˆç›´æ¥è¿”å›amount(A,B)Desiredã€‚å½“ä¸ä¸º0æ—¶ï¼Œå°±ä¼šé€šè¿‡quoteé¦–å…ˆæ ¹æ®amountADesiredçš„æ•°é‡ç®—å‡ºæœ€ä½³çš„amountBOptimal,å¦‚æœamountBOptimal&lt;amountBDesired,ä¸”amountBOptimal&gt;amountBMin(è¿™ä¸€æ¡ä¸é€šè¿‡ç›´æ¥æŠ¥é”™å›æ»š)ï¼Œé‚£ä¹ˆæˆåŠŸè¿”å›ï¼ˆamountADesired,amountBOptimalï¼‰ã€‚å¦‚æœBO&gt;BDçš„è¯ï¼Œåˆ™æ ¹æ®amountBDesiredç®—å‡ºamountAOptimal,å½“amountAOptimal&gt;amountAMinçš„è¯é‚£ä¹ˆå°±è¿”å›ï¼ˆamountBDesired,amountAOptimalï¼‰,å¦åˆ™å›æ»šã€‚</p>
<h2 id="addLiquidity-â€¦â€¦"><a href="#addLiquidity-â€¦â€¦" class="headerlink" title="addLiquidity(â€¦â€¦)"></a>addLiquidity(â€¦â€¦)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function addLiquidity(</span><br><span class="line">    address tokenA,</span><br><span class="line">    address tokenB,</span><br><span class="line">    uint amountADesired,</span><br><span class="line">    uint amountBDesired,</span><br><span class="line">    uint amountAMin,</span><br><span class="line">    uint amountBMin,</span><br><span class="line">    address to,</span><br><span class="line">    uint deadline</span><br><span class="line">) external virtual override ensure(deadline) returns (uint amountA, uint amountB, uint liquidity) &#123;</span><br><span class="line">    (amountA, amountB) = _addLiquidity(tokenA, tokenB, amountADesired, amountBDesired, amountAMin, amountBMin);</span><br><span class="line">    address pair = UniswapV2Library.pairFor(factory, tokenA, tokenB);</span><br><span class="line">    TransferHelper.safeTransferFrom(tokenA, msg.sender, pair, amountA);</span><br><span class="line">    TransferHelper.safeTransferFrom(tokenB, msg.sender, pair, amountB);</span><br><span class="line">    liquidity = IUniswapV2Pair(pair).mint(to);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tokenA å’Œ tokenB å°±æ˜¯é…å¯¹çš„ä¸¤ä¸ªä»£å¸ï¼ŒamountADesiredå’ŒamountBDesiredæ˜¯é¢„æœŸå‡†å¤‡ä¸ºæ·»åŠ æµåŠ¨æ€§ä»˜å‡ºçš„Tokenæ•°é‡ï¼ŒamountAMinå’ŒamountBMinæ˜¯ç”¨æˆ·å¯ä»¥æ¥å—çš„æœ€å°äº¤æ˜“æ•°é‡ï¼ˆæ ¹æ®æ»‘ç‚¹è®¡ç®—ï¼‰ï¼Œtoæ˜¯LP-Tokençš„æ¥æ”¶åœ°å€ï¼Œdeadlineæ˜¯è¿™ç¬”äº¤æ˜“çš„æœ‰æ•ˆæœŸï¼Œè¶…è¿‡æœ‰æ•ˆæœŸè¿˜æ²¡æœ‰äº¤æ˜“å°±ä¼šç›´æ¥å¤±æ•ˆ</p>
<p>é¦–å…ˆè°ƒç”¨_addLiquidity(â€¦..ï¼‰æ¥å¯»æ‰¾åˆ°æœ€ä½³çš„tokenA,Bæ•°é‡ï¼Œç„¶åè½¬è´¦ï¼ˆè½¬è´¦å‰å¿…é¡»æˆæƒRouteråˆçº¦ï¼Œå› ä¸ºä»–ç”¨çš„æ˜¯transferFromæ¥è½¬è´¦çš„ï¼‰ï¼Œæœ€åè°ƒç”¨pairåˆçº¦çš„mintï¼ˆtoï¼‰æ¥å®Œæˆæ·»åŠ æµåŠ¨æ€§</p>
<h2 id="addLiquidityETH-â€¦â€¦"><a href="#addLiquidityETH-â€¦â€¦" class="headerlink" title="addLiquidityETH(â€¦â€¦.)"></a>addLiquidityETH(â€¦â€¦.)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">function addLiquidityETH(</span><br><span class="line">    address token,</span><br><span class="line">    uint amountTokenDesired,</span><br><span class="line">    uint amountTokenMin,</span><br><span class="line">    uint amountETHMin,</span><br><span class="line">    address to,</span><br><span class="line">    uint deadline</span><br><span class="line">) external virtual override payable ensure(deadline) returns (uint amountToken, uint amountETH, uint liquidity) &#123;</span><br><span class="line">    (amountToken, amountETH) = _addLiquidity(</span><br><span class="line">        token,</span><br><span class="line">        WETH,</span><br><span class="line">        amountTokenDesired,</span><br><span class="line">        msg.value,</span><br><span class="line">        amountTokenMin,</span><br><span class="line">        amountETHMin</span><br><span class="line">    );</span><br><span class="line">    address pair = UniswapV2Library.pairFor(factory, token, WETH);</span><br><span class="line">    TransferHelper.safeTransferFrom(token, msg.sender, pair, amountToken);</span><br><span class="line">    IWETH(WETH).deposit&#123;value: amountETH&#125;();</span><br><span class="line">    assert(IWETH(WETH).transfer(pair, amountETH));</span><br><span class="line">    liquidity = IUniswapV2Pair(pair).mint(to);</span><br><span class="line">    // refund dust eth, if any</span><br><span class="line">    if (msg.value &gt; amountETH) TransferHelper.safeTransferETH(msg.sender, msg.value - amountETH);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨æ¥æ·»åŠ æµåŠ¨æ€§</p>
<p>ç”¨tokenä¸wethè¿›è¡Œé“¸é€ æµåŠ¨æ€§</p>
<p>é¦–å…ˆä¹Ÿæ˜¯é€šè¿‡_addLiquidity(â€¦â€¦â€¦.)æ¥å¯»æ‰¾åˆ°æœ€ä½³çš„æ•°é‡ï¼Œå…¶ä¸­wethçš„æ•°é‡æ˜¯msg.value,æ‰¾åˆ°æœ€ä½³ä¹‹åè½¬è´¦tokenä»£å¸ï¼Œç„¶åRouteråˆçº¦ä¼šå‚¨å­˜ç›¸åº”çš„ethåˆ°wethï¼Œç„¶åè½¬ç»™pairåˆçº¦ï¼Œç„¶åè°ƒç”¨mint(to)è¿›è¡Œé“¸é€ æµåŠ¨æ€§ï¼Œæœ€åå°†å¤šä½™çš„msg.valueè¿”è¿˜ç»™è°ƒç”¨è€…</p>
<h2 id="RemoveLiquidity"><a href="#RemoveLiquidity" class="headerlink" title="RemoveLiquidity"></a>RemoveLiquidity</h2><h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">function removeLiquidity(</span><br><span class="line">    address tokenA,</span><br><span class="line">    address tokenB,</span><br><span class="line">    uint liquidity,</span><br><span class="line">    uint amountAMin,</span><br><span class="line">    uint amountBMin,</span><br><span class="line">    address to,</span><br><span class="line">    uint deadline</span><br><span class="line">) public virtual override ensure(deadline) returns (uint amountA, uint amountB) &#123;</span><br><span class="line">    address pair = UniswapV2Library.pairFor(factory, tokenA, tokenB);</span><br><span class="line">    IUniswapV2Pair(pair).transferFrom(msg.sender, pair, liquidity); // send liquidity to pair</span><br><span class="line">    (uint amount0, uint amount1) = IUniswapV2Pair(pair).burn(to);</span><br><span class="line">    (address token0,) = UniswapV2Library.sortTokens(tokenA, tokenB);</span><br><span class="line">    (amountA, amountB) = tokenA == token0 ? (amount0, amount1) : (amount1, amount0);</span><br><span class="line">    require(amountA &gt;= amountAMin, &#x27;UniswapV2Router: INSUFFICIENT_A_AMOUNT&#x27;);</span><br><span class="line">    require(amountB &gt;= amountBMin, &#x27;UniswapV2Router: INSUFFICIENT_B_AMOUNT&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">function removeLiquidityETH(</span><br><span class="line">    address token,</span><br><span class="line">    uint liquidity,</span><br><span class="line">    uint amountTokenMin,</span><br><span class="line">    uint amountETHMin,</span><br><span class="line">    address to,</span><br><span class="line">    uint deadline</span><br><span class="line">) public virtual override ensure(deadline) returns (uint amountToken, uint amountETH) &#123;</span><br><span class="line">    (amountToken, amountETH) = removeLiquidity(</span><br><span class="line">        token,</span><br><span class="line">        WETH,</span><br><span class="line">        liquidity,</span><br><span class="line">        amountTokenMin,</span><br><span class="line">        amountETHMin,</span><br><span class="line">        address(this),</span><br><span class="line">        deadline</span><br><span class="line">    );</span><br><span class="line">    TransferHelper.safeTransfer(token, to, amountToken);</span><br><span class="line">    IWETH(WETH).withdraw(amountETH);</span><br><span class="line">    TransferHelper.safeTransferETH(to, amountETH);</span><br><span class="line">&#125;</span><br><span class="line">function removeLiquidityWithPermit(</span><br><span class="line">    address tokenA,</span><br><span class="line">    address tokenB,</span><br><span class="line">    uint liquidity,</span><br><span class="line">    uint amountAMin,</span><br><span class="line">    uint amountBMin,</span><br><span class="line">    address to,</span><br><span class="line">    uint deadline,</span><br><span class="line">    bool approveMax, uint8 v, bytes32 r, bytes32 s</span><br><span class="line">) external virtual override returns (uint amountA, uint amountB) &#123;</span><br><span class="line">    address pair = UniswapV2Library.pairFor(factory, tokenA, tokenB);</span><br><span class="line">    uint value = approveMax ? uint(-1) : liquidity;</span><br><span class="line">    IUniswapV2Pair(pair).permit(msg.sender, address(this), value, deadline, v, r, s);</span><br><span class="line">    (amountA, amountB) = removeLiquidity(tokenA, tokenB, liquidity, amountAMin, amountBMin, to, deadline);</span><br><span class="line">&#125;</span><br><span class="line">function removeLiquidityETHWithPermit(</span><br><span class="line">    address token,</span><br><span class="line">    uint liquidity,</span><br><span class="line">    uint amountTokenMin,</span><br><span class="line">    uint amountETHMin,</span><br><span class="line">    address to,</span><br><span class="line">    uint deadline,</span><br><span class="line">    bool approveMax, uint8 v, bytes32 r, bytes32 s</span><br><span class="line">) external virtual override returns (uint amountToken, uint amountETH) &#123;</span><br><span class="line">    address pair = UniswapV2Library.pairFor(factory, token, WETH);</span><br><span class="line">    uint value = approveMax ? uint(-1) : liquidity;</span><br><span class="line">    IUniswapV2Pair(pair).permit(msg.sender, address(this), value, deadline, v, r, s);</span><br><span class="line">    (amountToken, amountETH) = removeLiquidityETH(token, liquidity, amountTokenMin, amountETHMin, to, deadline);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// **** REMOVE LIQUIDITY (supporting fee-on-transfer tokens) ****</span><br><span class="line">function removeLiquidityETHSupportingFeeOnTransferTokens(</span><br><span class="line">    address token,</span><br><span class="line">    uint liquidity,</span><br><span class="line">    uint amountTokenMin,</span><br><span class="line">    uint amountETHMin,</span><br><span class="line">    address to,</span><br><span class="line">    uint deadline</span><br><span class="line">) public virtual override ensure(deadline) returns (uint amountETH) &#123;</span><br><span class="line">    (, amountETH) = removeLiquidity(</span><br><span class="line">        token,</span><br><span class="line">        WETH,</span><br><span class="line">        liquidity,</span><br><span class="line">        amountTokenMin,</span><br><span class="line">        amountETHMin,</span><br><span class="line">        address(this),</span><br><span class="line">        deadline</span><br><span class="line">    );</span><br><span class="line">    TransferHelper.safeTransfer(token, to, IERC20(token).balanceOf(address(this)));</span><br><span class="line">    IWETH(WETH).withdraw(amountETH);</span><br><span class="line">    TransferHelper.safeTransferETH(to, amountETH);</span><br><span class="line">&#125;</span><br><span class="line">function removeLiquidityETHWithPermitSupportingFeeOnTransferTokens(</span><br><span class="line">    address token,</span><br><span class="line">    uint liquidity,</span><br><span class="line">    uint amountTokenMin,</span><br><span class="line">    uint amountETHMin,</span><br><span class="line">    address to,</span><br><span class="line">    uint deadline,</span><br><span class="line">    bool approveMax, uint8 v, bytes32 r, bytes32 s</span><br><span class="line">) external virtual override returns (uint amountETH) &#123;</span><br><span class="line">    address pair = UniswapV2Library.pairFor(factory, token, WETH);</span><br><span class="line">    uint value = approveMax ? uint(-1) : liquidity;</span><br><span class="line">    IUniswapV2Pair(pair).permit(msg.sender, address(this), value, deadline, v, r, s);</span><br><span class="line">    amountETH = removeLiquidityETHSupportingFeeOnTransferTokens(</span><br><span class="line">        token, liquidity, amountTokenMin, amountETHMin, to, deadline</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Analyse-4"><a href="#Analyse-4" class="headerlink" title="Analyse"></a>Analyse</h3><p>å¤šç§removeæ–¹æ³•removeLiquidityå¯¹åº”ç€addLiquidity(â€¦â€¦)ï¼Œå°†lptokené”€æ¯ï¼Œç„¶åå¾—åˆ°ç›¸åº”çš„token0,1</p>
<h2 id="swap-â€¦â€¦â€¦"><a href="#swap-â€¦â€¦â€¦" class="headerlink" title="_swap(â€¦â€¦â€¦)"></a>_swap(â€¦â€¦â€¦)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function _swap(uint[] memory amounts, address[] memory path, address _to) internal virtual &#123;</span><br><span class="line">        for (uint i; i &lt; path.length - 1; i++) &#123;</span><br><span class="line">            (address input, address output) = (path[i], path[i + 1]);</span><br><span class="line">            (address token0,) = UniswapV2Library.sortTokens(input, output);</span><br><span class="line">            uint amountOut = amounts[i + 1];</span><br><span class="line">            (uint amount0Out, uint amount1Out) = input == token0 ? (uint(0), amountOut) : (amountOut, uint(0));</span><br><span class="line">            address to = i &lt; path.length - 2 ? UniswapV2Library.pairFor(factory, output, path[i + 2]) : _to;</span><br><span class="line">            IUniswapV2Pair(UniswapV2Library.pairFor(factory, input, output)).swap(</span><br><span class="line">                amount0Out, amount1Out, to, new bytes(0)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>éå†æ•´ä¸ªå…‘æ¢è·¯å¾„ï¼Œpath[i]ä¸ºinp Tokenï¼Œpath[i+1]ä¸ºoutput Tokenï¼Œåœ¨è¿›è¡Œamountçš„åŒ¹é…ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæœ€åä¸€æ¬¡å…‘æ¢ï¼Œæ˜¯åˆ™toä¸ºä¸º_toï¼Œå¦åˆ™toä¸ºä¸‹ä¸€ä¸ªå…‘æ¢åŒ¹é…çš„pairåˆçº¦åœ°å€ï¼Œæœ€åè°ƒç”¨pairåˆçº¦ä¸‹çš„swapå‡½æ•°å®ç°å…‘æ¢</p>
<h2 id="å…¶ä»–æ–¹å¼çš„swap"><a href="#å…¶ä»–æ–¹å¼çš„swap" class="headerlink" title="å…¶ä»–æ–¹å¼çš„swap"></a>å…¶ä»–æ–¹å¼çš„swap</h2><ul>
<li><p>swapExactTokensForTokensï¼šç”¨æŒ‡å®šæ•°é‡çš„TokenAå…‘æ¢æœªç¡®å®šæ•°é‡çš„TokenB</p>
</li>
<li><p>swapTokensForExactTokensï¼šç”¨æœªç¡®å®šæ•°é‡çš„TokenAæ¢å–ç¡®å®šæ•°é‡çš„TokenB</p>
</li>
<li><p>swapExactETHForTokensï¼šç”¨æŒ‡å®šæ•°é‡çš„çš„ETHå…‘æ¢ERC20 Token</p>
</li>
<li><p>swapTokensForExactETHï¼šç”¨æœªæŒ‡å®šæ•°é‡çš„Tokenæ¢å–æŒ‡å®šæ•°é‡çš„ETH</p>
</li>
<li><p>swapExactTokensForETHï¼šç”¨æŒ‡å®šæ•°é‡çš„Tokenå…‘æ¢å›æœªæŒ‡å®šæ•°é‡çš„ETH</p>
</li>
<li><p>swapETHForExactTokensï¼šç”¨æœªæŒ‡å®šæ•°é‡çš„ETHå…‘æ¢æŒ‡å®šæ•°é‡çš„Token</p>
</li>
<li><p>swapExactTokensForTokensSupportingFeeOnTransferTokensï¼šæŒ‡å®šæ•°é‡çš„Tokenå…‘æ¢Tokenï¼Œæ”¯æŒè½¬è´¦æ—¶æ‰£è´¹</p>
</li>
<li><p>swapExactETHForTokensSupportingFeeOnTransferTokensï¼šï¼šæŒ‡å®šæ•°é‡çš„ETHå…‘æ¢Tokenï¼Œæ”¯æŒè½¬è´¦æ—¶æ‰£è´¹</p>
</li>
<li><p>swapExactTokensForETHSupportingFeeOnTransferTokensï¼šæŒ‡å®šæ•°é‡çš„Tokenå…‘æ¢ ETHï¼Œæ”¯æŒè½¬è´¦æ—¶æ‰£è´¹</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://www.jjkwin.top">jjk</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://www.jjkwin.top/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/UniswapV2/">https://www.jjkwin.top/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/UniswapV2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://www.jjkwin.top" target="_blank">JKingğŸ¥</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/11/27/S7982YFMinXbqNg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/07/23/web3.js/%E4%BD%BF%E7%94%A8web3.js%E9%83%A8%E7%BD%B2%E5%90%88%E7%BA%A6/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/11/27/S7982YFMinXbqNg.jpg" onerror="onerror=null;src='/img/j.JPG'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ä½¿ç”¨web3.jséƒ¨ç½²åˆçº¦</div></div></a></div><div class="next-post pull-right"><a href="/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/Proxy%E4%BB%A3%E7%90%86%E5%90%88%E7%BA%A6%E7%9A%84%E7%90%86%E8%A7%A3/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/11/27/8Ex9jvkd43DhibT.jpg" onerror="onerror=null;src='/img/j.JPG'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Proxyä»£ç†åˆçº¦çš„ç†è§£</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/w.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">jjk</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/jjk812"><i class="fab fa-github"></i><span>let'go</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">Welcome to my blog!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ERC20-amp-amp-Pair-amp-amp-Factory"><span class="toc-number">1.</span> <span class="toc-text">ERC20&amp;&amp;Pair&amp;&amp;Factory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Total-Code"><span class="toc-number">1.1.</span> <span class="toc-text">Total Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UniswapV2ERC20"><span class="toc-number">1.2.</span> <span class="toc-text">UniswapV2ERC20</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Code"><span class="toc-number">1.2.1.</span> <span class="toc-text">Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyse"><span class="toc-number">1.2.2.</span> <span class="toc-text">Analyse</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UniswapV2Pair"><span class="toc-number">1.3.</span> <span class="toc-text">UniswapV2Pair</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-1"><span class="toc-number">1.3.1.</span> <span class="toc-text">Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyse-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">Analyse</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getReserves"><span class="toc-number">1.3.3.</span> <span class="toc-text">getReserves()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#initialize-address-token0-address-token1"><span class="toc-number">1.3.4.</span> <span class="toc-text">initialize(address _token0, address _token1)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#updata-uint-balance0-uint-balance1-uint112-reserve0-uint112-reserve1"><span class="toc-number">1.3.5.</span> <span class="toc-text">_updata(uint balance0, uint balance1, uint112 _reserve0, uint112 _reserve1)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mint-to"><span class="toc-number">1.3.6.</span> <span class="toc-text">mint(to)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mintFee-uint112-reserve0-uint112-reserve1"><span class="toc-number">1.3.7.</span> <span class="toc-text">_mintFee(uint112 _reserve0, uint112 _reserve1)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#burn-to"><span class="toc-number">1.3.8.</span> <span class="toc-text">burn(to)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#swap-uint-amount0Out-uint-amount1Out-address-to-bytes-calldata-data"><span class="toc-number">1.3.9.</span> <span class="toc-text">swap(uint amount0Out, uint amount1Out, address to, bytes calldata data)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#skim-address-to"><span class="toc-number">1.3.10.</span> <span class="toc-text">skim(address to)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sync%EF%BC%88address-to%EF%BC%89"><span class="toc-number">1.3.11.</span> <span class="toc-text">syncï¼ˆaddress toï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UniswapV2Factory"><span class="toc-number">1.4.</span> <span class="toc-text">UniswapV2Factory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-2"><span class="toc-number">1.4.1.</span> <span class="toc-text">Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Anaylse"><span class="toc-number">1.4.2.</span> <span class="toc-text">Anaylse</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#creatPair"><span class="toc-number">1.4.3.</span> <span class="toc-text">creatPair()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#library-UQ11"><span class="toc-number">1.4.4.</span> <span class="toc-text">library UQ11</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#UniswapV2Library"><span class="toc-number">2.</span> <span class="toc-text">UniswapV2Library</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Code-3"><span class="toc-number">2.1.</span> <span class="toc-text">Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analyse-2"><span class="toc-number">2.2.</span> <span class="toc-text">Analyse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sortTokens-address-tokenA-address-tokenB"><span class="toc-number">2.3.</span> <span class="toc-text">sortTokens(address tokenA,address tokenB)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pairFor-address-factory-address-tokenA-address-tokenB"><span class="toc-number">2.4.</span> <span class="toc-text">pairFor(address factory, address tokenA, address tokenB)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getReserves-address-factory-address-tokenA-address-tokenB"><span class="toc-number">2.5.</span> <span class="toc-text">getReserves(address factory, address tokenA, address tokenB)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#quote-uint-amountA-uint-reserveA-uint-reserveB"><span class="toc-number">2.6.</span> <span class="toc-text">quote(uint amountA, uint reserveA, uint reserveB)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getAmountOut-uint-amountIn-uint-reserveIn-uint-reserveOut"><span class="toc-number">2.7.</span> <span class="toc-text">getAmountOut(uint amountIn, uint reserveIn, uint reserveOut)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getAmountIn-uint-amountOut-uint-reserveIn-uint-reserveOut"><span class="toc-number">2.8.</span> <span class="toc-text">getAmountIn(uint amountOut, uint reserveIn, uint reserveOut)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#getAmountsOut-address-factory-uint-amountIn-address-memory-path"><span class="toc-number">2.9.</span> <span class="toc-text">getAmountsOut(address factory, uint amountIn, address[] memory path)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#UniswapV2Router02"><span class="toc-number">3.</span> <span class="toc-text">UniswapV2Router02</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Code-4"><span class="toc-number">3.1.</span> <span class="toc-text">Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analyse-3"><span class="toc-number">3.2.</span> <span class="toc-text">Analyse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#addLiquidity-%E2%80%A6%E2%80%A6%E2%80%A6"><span class="toc-number">3.3.</span> <span class="toc-text">_addLiquidity(â€¦â€¦â€¦.)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#addLiquidity-%E2%80%A6%E2%80%A6"><span class="toc-number">3.4.</span> <span class="toc-text">addLiquidity(â€¦â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#addLiquidityETH-%E2%80%A6%E2%80%A6"><span class="toc-number">3.5.</span> <span class="toc-text">addLiquidityETH(â€¦â€¦.)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RemoveLiquidity"><span class="toc-number">3.6.</span> <span class="toc-text">RemoveLiquidity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Source-Code"><span class="toc-number">3.6.1.</span> <span class="toc-text">Source Code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyse-4"><span class="toc-number">3.6.2.</span> <span class="toc-text">Analyse</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#swap-%E2%80%A6%E2%80%A6%E2%80%A6"><span class="toc-number">3.7.</span> <span class="toc-text">_swap(â€¦â€¦â€¦)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E5%BC%8F%E7%9A%84swap"><span class="toc-number">3.8.</span> <span class="toc-text">å…¶ä»–æ–¹å¼çš„swap</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/07/23/web3.js/%E4%BD%BF%E7%94%A8web3.js%E6%89%A7%E8%A1%8Ctx/" title="ä½¿ç”¨web3.jsæ‰§è¡Œtx"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/11/27/S7982YFMinXbqNg.jpg" onerror="this.onerror=null;this.src='/img/j.JPG'" alt="ä½¿ç”¨web3.jsæ‰§è¡Œtx"/></a><div class="content"><a class="title" href="/2023/07/23/web3.js/%E4%BD%BF%E7%94%A8web3.js%E6%89%A7%E8%A1%8Ctx/" title="ä½¿ç”¨web3.jsæ‰§è¡Œtx">ä½¿ç”¨web3.jsæ‰§è¡Œtx</a><time datetime="2023-07-23T09:00:00.000Z" title="å‘è¡¨äº 2023-07-23 17:00:00">2023-07-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/23/web3.js/%E4%BD%BF%E7%94%A8web3.js%E9%83%A8%E7%BD%B2%E5%90%88%E7%BA%A6/" title="ä½¿ç”¨web3.jséƒ¨ç½²åˆçº¦"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/11/27/S7982YFMinXbqNg.jpg" onerror="this.onerror=null;this.src='/img/j.JPG'" alt="ä½¿ç”¨web3.jséƒ¨ç½²åˆçº¦"/></a><div class="content"><a class="title" href="/2023/07/23/web3.js/%E4%BD%BF%E7%94%A8web3.js%E9%83%A8%E7%BD%B2%E5%90%88%E7%BA%A6/" title="ä½¿ç”¨web3.jséƒ¨ç½²åˆçº¦">ä½¿ç”¨web3.jséƒ¨ç½²åˆçº¦</a><time datetime="2023-07-23T09:00:00.000Z" title="å‘è¡¨äº 2023-07-23 17:00:00">2023-07-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/UniswapV2/" title="UniswapV2"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/11/27/S7982YFMinXbqNg.jpg" onerror="this.onerror=null;this.src='/img/j.JPG'" alt="UniswapV2"/></a><div class="content"><a class="title" href="/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/UniswapV2/" title="UniswapV2">UniswapV2</a><time datetime="2023-07-22T13:13:14.393Z" title="å‘è¡¨äº 2023-07-22 21:13:14">2023-07-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/Proxy%E4%BB%A3%E7%90%86%E5%90%88%E7%BA%A6%E7%9A%84%E7%90%86%E8%A7%A3/" title="Proxyä»£ç†åˆçº¦çš„ç†è§£"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/11/27/8Ex9jvkd43DhibT.jpg" onerror="this.onerror=null;this.src='/img/j.JPG'" alt="Proxyä»£ç†åˆçº¦çš„ç†è§£"/></a><div class="content"><a class="title" href="/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/Proxy%E4%BB%A3%E7%90%86%E5%90%88%E7%BA%A6%E7%9A%84%E7%90%86%E8%A7%A3/" title="Proxyä»£ç†åˆçº¦çš„ç†è§£">Proxyä»£ç†åˆçº¦çš„ç†è§£</a><time datetime="2023-07-22T13:11:30.988Z" title="å‘è¡¨äº 2023-07-22 21:11:30">2023-07-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/TreasureDAO%E6%94%BB%E5%87%BB%E4%BA%8B%E4%BB%B6/" title="TreasureDAOæ”»å‡»äº‹ä»¶"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/11/27/S7982YFMinXbqNg.jpg" onerror="this.onerror=null;this.src='/img/j.JPG'" alt="TreasureDAOæ”»å‡»äº‹ä»¶"/></a><div class="content"><a class="title" href="/2023/07/22/solidity/%E7%B2%BE%E5%8D%8E/TreasureDAO%E6%94%BB%E5%87%BB%E4%BA%8B%E4%BB%B6/" title="TreasureDAOæ”»å‡»äº‹ä»¶">TreasureDAOæ”»å‡»äº‹ä»¶</a><time datetime="2023-07-22T13:02:25.828Z" title="å‘è¡¨äº 2023-07-22 21:02:25">2023-07-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By jjk</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹„1ï¿½7</button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://liuyan-zeta.vercel.app/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://liuyan-zeta.vercel.app/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="33" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 190px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 160px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://s2.loli.net/2022/11/27/2FijVHgntB4zIGP.jpg);"> <a class="categoryBar-list-link" href="categories/htmlå­¦ä¹ ç¬”è®°/">-htmlå­¦ä¹ ç¬”è®°</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">solidityå­¦ä¹ ç¬”è®°</span></li><li class="categoryBar-list-item" style="background:url(https://s2.loli.net/2022/11/27/RfqUri6hZtapyFw.jpg);"> <a class="categoryBar-list-link" href="categories/MarkDownè¯­æ³•/">-MarkDownè¯­æ³•</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">æ–‡ç« </span></li><li class="categoryBar-list-item" style="background:url(https://s2.loli.net/2022/11/27/U5VqSZeCEDuFtYO.jpg);"> <a class="categoryBar-list-link" href="categories/web3-js/">-web3.js</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr">javaå­¦ä¹ ç¬”è®°</span></li><li class="categoryBar-list-item" style="background:url(https://s2.loli.net/2022/11/27/Qy3CiPvBdTXExKa.jpg);"> <a class="categoryBar-list-link" href="categories/solidityå­¦ä¹ ç¬”è®°/">-solidityå­¦ä¹ ç¬”è®°</a><span class="categoryBar-list-count">7</span><span class="categoryBar-list-descr">ä¸ªäººæ—¥è®°</span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" href="categories/solidityé¶åœº/">-solidityé¶åœº</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" href="categories/solidityåŸºç¡€æ”»å‡»/">-solidityåŸºç¡€æ”»å‡»</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" href="categories/çŸ¥è¯†/">-çŸ¥è¯†</a><span class="categoryBar-list-count">5</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" href="categories/é¶åœº/">-é¶åœº</a><span class="categoryBar-list-count">5</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
      console.log('å·²æŒ‚è½½butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = 'b16a1fa0e63c46a4b8f28abfb06ae3fe';
  var gaud_map_key = 'e2b04289e870b005374ee030148d64fd&s=rsv3';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '113.34532,23.15624';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '2');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>